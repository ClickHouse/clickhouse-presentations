<!DOCTYPE html>
<html lang="en">
<head>
    <title>Typical Pitfalls of Analytics Using Git Data as an Example</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:image" content="pictures/preview.jpg">
    <meta property="og:title" content="Typical Pitfalls of Analytics Using Git Data as an Example">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="pictures/preview.jpg">
    <link rel="stylesheet" href="shower/themes/yandex/styles/screen-16x9.css">

    <style type="text/css">
         code { display: block; white-space: pre; background-color: #EEE; }
    </style>
</head>
<body class="shower list">
    <header class="caption">
        <h1>Typical Pitfalls of Analytics Using Git Data as an Example</h1>
    </header>
    <section class="slide" id="cover" style="background: #000;">
        <img style="float: right; width: 120px; height: 80px; margin-right: -80px;" src="pictures/inner_black.svg" />
        <h1 style="margin-top: 50px; margin-left: -40px; line-height: 150%; color: white;">Typical Pitfalls of Analytics<br/>Using Git Data as an Example</h1>
        <p style="color: #7c55e1; margin-left: 260px; margin-top: 2em;"><b>Alexey Milovidov</b></p>
    </section>


<section class="slide">
<h2 style="font-size: 30pt;">Episode 1</h2>
<p>Taking data from <b>Git</b> to analyze development processes.</p>
<p>Using this task as an example, I will talk about:</p>
<p>&mdash; trivial facts<br/>
&mdash; and truisms,<br/>
&emsp; that everyone already knows.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">What is Git</h2>
<p>What is the difference between Git and GitHub?</p>
<p><b>Git</b> &mdash; a distributed version control system.</p>
<p><b>GitHub</b> &mdash; a centralized hosting for Git repositories<br/>+ a social network for developers.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">What We Want to Get</h2>
<p>
&mdash; files with the maximum and minimum number of authors;<br/>
&mdash; the oldest lines of code in the repository;<br/>
&mdash; files with the longest history;<br/>
&mdash; favorite files for each author;<br/>
&mdash; large files with a small number of authors;<br/>
&mdash; on which days of the week is it better to write code,<br/>
&emsp; so that it has less chance of being deleted;<br/>
&mdash; files sorted by code age;<br/>
&mdash; who wrote the most code;<br/>
&mdash; who wrote the most code that wasn't deleted;<br/>
&mdash; whose code is most often rewritten;<br/>
&mdash; find pairs of authors where one writes code and another deletes it;<br/>
&mdash; median time for deleting lines of code;<br/>
&mdash; which code was rewritten the most;<br/>
&mdash; who likes writing comments or tests more;<br/>
</p>
</section>

<section class="slide">
<div style="color: gray; font-size: 50%; line-height: 1; text-align: right; float: right; height: 50%; margin-right: -80px; margin-top: 20px;"><img style="height: 100%;" src="pictures/xkcd.png" /><br/>https://xkcd.com/1597/</div>
<h2 style="font-size: 30pt;">Git Data Model</h2>
<p>What does a Git repository consist of?</p>
<p>A repository consists of blobs, trees, and commits.</p>
<p>Everything has a hash that uniquely identifies the content.</p>
<p><b>Blob</b> &mdash; file content.</p>
<p><b>Tree</b> &mdash; a snapshot of directory contents, references trees and blobs.</p>
<p><b>Commit</b> &mdash; a reference to a tree and parent commits.</p>
<p>Commits reference each other and form a graph.</p>
<p>If a commit has more than one parent &mdash; it's a merge.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Git Data Model</h2>
<p>Important notes:</p>
<p>Git doesn't store diffs between commits.<br/>It stores snapshots of file contents, and diffs are computed on the fly.</p>
<p>Git doesn't store line authorship. It's computed on the fly by viewing the history in sequence until the needed diff is found.</p>
<p>Git doesn't have linear history. There's no way to represent a repository as a sequence of patches while preserving authorship.</p>
<p>git log &mdash; is just one way to traverse the commit graph</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">What to Do With This?</h2>
<p>Put everything into a relational DB* and run SELECT queries.</p>
<p>But Git's data model is not relational<br/>
&mdash; we'll have to make compromises.</p>
<p style="margin-top: 10em; color: gray; font-size: 75%">* of course in ClickHouse.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Method 1</h2>
<p>Take the current state of the repository.</p>
<p>Calculate <b>blame</b> for each file (git blame)<br/>&mdash; authorship and commit time of each line.</p>
<p>Put each line of each file into a table.</p>
<p>Data volume &mdash; is simply LOC.</p>
<pre style="line-height: 1.25">ClickHouse:      732,048 lines (without contrib)
LLVM:          9,809,148 lines
Chromium:     15,063,229 lines (without third_party)
Linux Kernel: 21,645,046 lines

<span style="color: gray;">Yandex internal repository: ??? lines.</span></pre>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Method 1</h2>
<p>
<span style="color: green;">&mdash; files with the maximum and minimum number of authors;</span><br/>
<span style="color: green;">&mdash; the oldest lines of code in the repository;</span><br/>
<span style="color: green;">&mdash; files with the longest history;</span><br/>
&mdash; favorite files for each author;<br/>
<span style="color: green;">&mdash; large files with a small number of authors;</span><br/>
&mdash; on which days of the week is it better to write code,<br/>
&emsp; so that it has less chance of being deleted;<br/>
<span style="color: green;">&mdash; files sorted by code age;</span><br/>
<span style="color: green;">&mdash; who wrote the most code;</span><br/>
&mdash; who wrote the most code that wasn't deleted;<br/>
&mdash; whose code is most often rewritten;<br/>
&mdash; find pairs of authors where one writes code and another deletes it;<br/>
&mdash; median time for deleting lines of code;<br/>
&mdash; which code was rewritten the most;<br/>
&mdash; who likes writing comments or tests more;<br/>
</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Method 2</h2>
<p>Take all commits.<br/>
For each commit, take the repository state.</p>
<p>Data volume, upper bound estimate:
<br/>number of lines now * number of commits / 2</p>
<p>ClickHouse &mdash; 732,048 lines * 51,055 commits / 2 = 18.6 billion.<br/>
Linux Kernel &mdash; 21,645,046 lines * 950,019 commits / 2 = <span style="color: red;">10 trillion</span>.</p>
<p style="color: red;">Everything can be calculated, but there's too much data :(</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Method 3</h2>
<p>Take all commits.</p>
<p>For each commit, get the <b>diff</b> (git show).</p>
<p>We get added and deleted lines of code.</p>
<p>Write everything to the database!</p>
<p>Data volume &mdash; several times more than LOC.<br/>
... depending on how many times on average the code was rewritten.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Method 3</h2>
<p>Disadvantages:<br/>
<p>For merge commits, diff is non-trivial,<br/>as it shows changes relative to several parents.</p>
<p>Solution: just skip merge commits.</p>
<p>Changes for conflict resolution won't be included in statistics.</p>
<p>Statistics will be <span style="color: red;">inaccurate</span>... oh well.</p>
<p style="color: green;">But we have change history and can calculate everything!</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Defining the Data Model</h2>
<p style="margin-top: -1em;">Three tables:</p>
<pre style="font-size: 75%"><b>commits</b>
  hash String,
  author LowCardinality(String),
  time DateTime,
  message String,
  ...</pre>
<pre style="font-size: 75%"><b>file_changes</b>
  change_type Enum('Add' = 1, 'Delete' = 2, 'Modify' = 3, 'Rename' = 4...),
  path LowCardinality(String),
  old_path LowCardinality(String),
  file_extension LowCardinality(String),
  ...</pre>
<pre style="font-size: 75%"><b>line_changes</b>
  sign Int8,
  line_number_old UInt32,
  line_number_new UInt32,
  line LowCardinality(String),
  indent UInt8,
  line_type Enum('Empty' = 0, 'Comment' = 1, 'Punct' = 2, 'Code' = 3),
  ...</pre>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Defining the Data Model</h2>
<p style="margin-top: -1em;">Principles:</p>
<p><b>1. Denormalization.</b><br/>
In each file_changes row, duplicate all commit properties.<br/>
In each line_changes row, duplicate all file_changes properties and two commits &mdash; current and previous from blame.
</p>
<p><b>2. Enrichment with statistics.</b><br/>
In each commits row, also add:<br/>
- number of added and deleted files;<br/>
- number of added and deleted lines;
</p>
<p><b>3. Pre-computation of individual details.</b><br/>
- calculate the indentation level of the line and put it in a separate column;<br/>
- calculate whether the line is empty, a comment, code...;<br/>
- save the file extension in a separate column too.
</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Defining the Data Model</h2>
<p style="margin-top: -1em;">Principles:</p>
<p>1. Denormalization.</p>
<p>2. Enrichment with statistics.</p>
<p>3. Pre-computation of individual details.</p>
<p>These principles are <span style="color: red;">contraindicated</span> for transactional DBs<br/>
&emsp; and <span style="color: green;">very good</span> for analytical DBs.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Defining the Data Model</h2>
<pre style="margin-top: -3em; font-size: 43%;">CREATE TABLE git.line_changes
(
    sign Int8,
    line_number_old UInt32,
    line_number_new UInt32,
    hunk_num UInt32,
    hunk_start_line_number_old UInt32,
    hunk_start_line_number_new UInt32,
    hunk_lines_added UInt32,
    hunk_lines_deleted UInt32,
    hunk_context LowCardinality(String),
    line LowCardinality(String),
    indent UInt8,
    line_type Enum('Empty' = 0, 'Comment' = 1, 'Punct' = 2, 'Code' = 3),

    prev_commit_hash String,
    prev_author LowCardinality(String),
    prev_time DateTime,

    file_change_type Enum('Add' = 1, 'Delete' = 2, 'Modify' = 3, 'Rename' = 4, 'Copy' = 5, 'Type' = 6),
    path LowCardinality(String),
    old_path LowCardinality(String),
    file_extension LowCardinality(String),
    file_lines_added UInt32,
    file_lines_deleted UInt32,
    file_hunks_added UInt32,
    file_hunks_removed UInt32,
    file_hunks_changed UInt32,

    commit_hash String,
    author LowCardinality(String),
    time DateTime,
    commit_message String,
    commit_files_added UInt32,
    commit_files_deleted UInt32,
    commit_files_renamed UInt32,
    commit_files_modified UInt32,
    commit_lines_added UInt32,
    commit_lines_deleted UInt32,
    commit_hunks_added UInt32,
    commit_hunks_removed UInt32,
    commit_hunks_changed UInt32
) ENGINE = MergeTree ORDER BY time;
</pre>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Writing a Script</h2>
<p>I tried to write a script in bash but failed.</p>
<p>Wrote a script in C++ :) <span style="color: gray">(could have been in Python)</span>.</p>
<p>This is not a recommendation.<br/>You are analysts. Write in whatever you want.</p>
<p><a href="https://github.com/ClickHouse/ClickHouse/pull/14471">https://github.com/ClickHouse/ClickHouse/pull/14471</a></p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Running the Script</h2>
<pre>clickhouse-git-import --help</pre>
<p>Repository processing and table sizes in ClickHouse:</p>
<pre style="line-height: 1.5">
- ClickHouse:  31 sec;    6M rows;  122 MB;
- LLVM:         8 min;   62M rows;  1.2 GB;
- Linux:       12 min;   85M rows;  1.7 GB;
- Chromium:    67 min;  343M rows;  6.8 GB.
</pre>
<p style="color: green;">Tiny data volume! Can be analyzed on a laptop.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Analyzing Data</h2>
<p>Number of authors who wrote the most lines of code.</p>
<p>LOC &mdash; the dumbest metric of all :(</p>
<p>Options:<br/>
&mdash; everything written or only lines that weren't deleted?<br/>
&mdash; only added lines of code or is deleting code also important?<br/>
&mdash; how to account for code, tests, documentation?
</p>
</section>

<section class="slide">
<code style="font-size: 80%;">SELECT author AS k, count() AS c
FROM line_changes
WHERE file_extension IN ('h', 'cpp')
GROUP BY k ORDER BY c DESC LIMIT 20

┌─k────────────────────┬───────c─┐
│ Alexey Milovidov     │ 1061697 │
│ <b>proller</b>              │  200704 │ &lt;-- commits of third-party code
│ Nikolai Kochetov     │  183370 │
│ Alexey Arno          │  107018 │
│ Vitaly Baranov       │   93296 │
│ Andrey Mironov       │   92973 │
│ <b>Guillaume Tassery</b>    │   89530 │ &lt;-- commit and deletion
│ alesapin             │   86999 │  of auto-generated files
│ Vitaliy Lyudvichenko │   85609 │
│ Michael Kolupaev     │   69178 │
│ CurtizJ              │   62607 │
│ chertus              │   53425 │
│ Alexey Zatelepin     │   49331 │
│ zhang2014            │   48352 │
│ Alexander Tokmakov   │   46371 │
│ <b>alexey-milovidov</b>     │   41518 │ &lt;-- duplicate
│ <b>peshkurov</b>            │   36525 │ &lt;-- corrupted git history,
│ Nikita Mikhaylov     │   30226 │  snapshot committed without parent.
│ Nikita Vasilev       │   28182 │
│ Artem Zuikov         │   25176 │
└──────────────────────┴─────────┘</code>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Warnings</h2>
<p>Query executed in 0.009 sec. But to understand why the result is garbage will take hours of investigation.</p>
<p>You cannot measure developer productivity<br/>by physical properties of the repository.</p>
<p>Lines of code &mdash; is a very poor metric.</p>
<p><b>If you aggregate data and calculate top N<br/>&mdash; you will see, first of all, data outliers.</b></p>
<p>You'll have to investigate outliers, and data will need to be cleaned.</p>
<p>One aggregated report is not the result.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Something More Interesting</h2>
<p style="margin-top: -1em;">Authors and the share of their code deleted by other authors:</p>
<code style="font-size: 75%; line-height: 1.1;">SELECT k, written_code.c, removed_code.c,
    round(removed_code.c * 100 / written_code.c) AS remove_ratio
FROM (
    SELECT <b style="color: green;">author</b> AS k, count() AS c
    FROM line_changes
    WHERE <b style="color: green;">sign = 1</b> AND file_extension IN ('h', 'cpp')
        AND line_type NOT IN ('Punct', 'Empty')
    GROUP BY k
) AS written_code
INNER JOIN (
    SELECT <b style="color: blue;">prev_author</b> AS k, count() AS c
    FROM line_changes
    WHERE <b style="color: blue;">sign = -1</b> AND file_extension IN ('h', 'cpp')
        AND line_type NOT IN ('Punct', 'Empty')
        AND <b style="color: green;">author</b> != <b style="color: blue;">prev_author</b>
    GROUP BY k
) AS removed_code USING (k)
WHERE written_code.c > 1000
ORDER BY c DESC LIMIT 500</code>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Something More Interesting</h2>
<p style="margin-top: -1em;">Authors and the share of their code deleted by other authors:</p>
<code style="font-size: 75%; line-height: 1.1;">┌─k───────────────────────┬──────c─┬─removed_code.c─┬─remove_ratio─┐
│ Alexey Milovidov        │ 426656 │         113306 │           27 │
│ Nikolai Kochetov        │  83479 │          16999 │           20 │
│ Andrey Mironov          │  55097 │          43989 │           80 │
│ Alexey Arno             │  49474 │          22664 │           46 │
│ Vitaliy Lyudvichenko    │  47603 │          31890 │           67 │
│ Vitaly Baranov          │  44032 │           3010 │            7 │
│ alesapin                │  40617 │           8505 │           21 │
│ proller                 │  36638 │          19471 │           53 │
│ Michael Kolupaev        │  31523 │          21182 │           67 │
│ peshkurov               │  25442 │          24556 │           97 │
│ chertus                 │  24013 │           6961 │           29 │
│ CurtizJ                 │  23684 │           7604 │           32 │
│ Alexey Zatelepin        │  22892 │          11105 │           49 │
│ Alexander Tokmakov      │  21147 │           2524 │           12 │
│ zhang2014               │  20476 │           3900 │           19 │
│ alexey-milovidov        │  16513 │          10415 │           63 │
│ Nikita Vasilev          │  14099 │           2633 │           19 │
│ Guillaume Tassery       │  12431 │           1199 │           10 │
│ Nikita Mikhaylov        │  11673 │           1447 │           12 │
</code>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Conclusions</h2>
<p>The resulting tool is a good toy.</p>
<p>Metrics can be calculated from this data...<br/>but blindly relying on them &mdash; no.</p>
<p>The tool can be given to a person who will<br/><span style="color: green;">doubt, think, and double-check the data</span>.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Episode 2</h2>
<p><b>GitHub</b> &mdash; centralized hosting for <b>Git</b> repositories;<br/>
+ a social network for developers;<br/>
+ collaboration tools.</p>
<p>What's not in <b>Git</b> repository data:<br/>
&mdash; issues (task tracker);<br/>
&mdash; pull requests;<br/>
&mdash; code review, stars, likes and comments.</p>
<p>This is implemented by <b>GitHub</b> itself.</p>
<p>I want to extract and analyze all the data!</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Importing GitHub Data</h2>
<p>&mdash; GitHub API;</p>
<p>&mdash; GH Archive: <a href="https://www.gharchive.org/">https://www.gharchive.org/</a>.</p>
<p>Data about events that occurred in repositories.</p>
<p>GH Archive &mdash; an updated archive of data about all GitHub repositories!</p>
</section>

<section class="slide">
<img style="float: right; height: 105%; margin-right: -100px; margin-top: -21px;" src="pictures/json.png" />
<h2 style="font-size: 30pt;">Importing GitHub Data</h2>
<p style="margin-top: -1em;">GitHub API event types:</p>
<p>&mdash; CommitCommentEvent;<br/>
&mdash; CreateEvent;<br/>
&mdash; DeleteEvent;<br/>
&mdash; ForkEvent;<br/>
&mdash; GollumEvent;<br/>
&mdash; IssueCommentEvent;<br/>
&mdash; IssuesEvent;<br/>
&mdash; MemberEvent;<br/>
&mdash; PublicEvent;<br/>
&mdash; PullRequestEvent;<br/>
&mdash; PullRequestReviewCommentEvent;<br/>
&mdash; PushEvent;<br/>
&mdash; ReleaseEvent;<br/>
&mdash; SponsorshipEvent;<br/>
&mdash; WatchEvent;</p>
<!-- TODO картинка JSON -->
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Importing GitHub Data</h2>
<pre style="font-size: 80%;">wget --continue \
https://data.gharchive.org/{2015..2020}-{01..12}-{01..31}-{0..23}.json.gz</pre>
<p>All data is open and you can download it!</p>
<p>Just wait a few days while downloading<br/>
84,264 files totaling 1.2 TB.</p>
<p style="color: gray">Can be accelerated by splitting across servers, but why...<br/>when you can just leave it for the weekend and forget.</p>
</section>

<section class="slide">
<img style="float: right; height: 60%; margin-right: -47px; margin-top: -50px; margin-left: 20px;" src="pictures/not_optimal.webp"/>
<h2 style="font-size: 30pt;">Analyzing GitHub Data</h2>
<p>How to analyze 1.2 TB of .json.gz files?</p>
<p>Method 1. As is. Don't load anywhere.<br/>
Analyze using <b>clickhouse-local</b>:</p>
<code style="margin-bottom: 1em; font-size: 14pt; line-height: 1.3"><b>clickhouse-local</b> --query "
    SELECT count() FROM <b>file</b>('*.json.gz', TSV, 'data String')
    WHERE <b>JSONExtractString</b>(data, 'actor', 'login') = 'alexey-milovidov'"</code>
<p>Query hits disk and takes ~30 minutes.<br/>
Bottleneck &mdash; reading all available data.</p>
<p>This is not optimal!</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Analyzing GitHub Data</h2>
<p>How to analyze 1.2 TB of .json.gz files?</p>
<p>Method 2. Put into a table in <b>ClickHouse</b>.</p>
<p>But the data has a very <span style="color: red;">complex structure</span>.<br/>
&mdash; 15 different events, each with many attributes.</p>
<p>Solution: <span style="color: green;">simplify the structure</span>!</p>
</section>

<section class="slide">
<pre style="font-size: 45%;">CREATE TABLE github_events
(
    event_type Enum('CommitCommentEvent' = 1, 'CreateEvent' = 2, 'DeleteEvent' = 3, 'ForkEvent' = 4,
                    'GollumEvent' = 5, 'IssueCommentEvent' = 6, 'IssuesEvent' = 7, 'MemberEvent' = 8,
                    'PublicEvent' = 9, 'PullRequestEvent' = 10, 'PullRequestReviewCommentEvent' = 11,
                    'PushEvent' = 12, 'ReleaseEvent' = 13, 'SponsorshipEvent' = 14, 'WatchEvent' = 15,
                    'GistEvent' = 16, 'FollowEvent' = 17, 'DownloadEvent' = 18, 'PullRequestReviewEvent' = 19),
    actor_login LowCardinality(String),
    repo_name LowCardinality(String),
    created_at DateTime,
    updated_at DateTime,
    action Enum('none' = 0, 'created' = 1, 'added' = 2, 'edited' = 3, 'deleted' = 4, 'opened' = 5, 'closed' = 6,
        'reopened' = 7, 'assigned' = 8, 'unassigned' = 9, 'labeled' = 10, 'unlabeled' = 11, 'review_requested' = 12,
        'review_request_removed' = 13, 'synchronize' = 14, 'started' = 15, 'published' = 16),
    comment_id UInt64,
    body String,
    path String,
    position UInt32,
    line UInt32,
    ref LowCardinality(String),
    ref_type Enum('none' = 0, 'branch' = 1, 'tag' = 2, 'repository' = 3),
    creator_user_login LowCardinality(String),
    number UInt32,
    title String,
    labels Array(LowCardinality(String)),
    state Enum('none' = 0, 'open' = 1, 'closed' = 2),
    locked UInt8,
    assignee LowCardinality(String),
    assignees Array(LowCardinality(String)),
    comments UInt32,
    author_association Enum('NONE' = 0, 'CONTRIBUTOR' = 1, 'OWNER' = 2, 'COLLABORATOR' = 3, 'MEMBER' = 4),
    closed_at DateTime,
    merged_at DateTime,
    merge_commit_sha String,
    requested_reviewers Array(LowCardinality(String)),
    requested_teams Array(LowCardinality(String)),
    head_ref LowCardinality(String),
    head_sha String,
    base_ref LowCardinality(String),
    base_sha String,
    merged UInt8,
    mergeable UInt8,
    rebaseable UInt8,
    mergeable_state Enum('unknown' = 0, 'dirty' = 1, 'clean' = 2, 'unstable' = 3, 'draft' = 4),
    merged_by LowCardinality(String),
    review_comments UInt32,
    maintainer_can_modify UInt8,
    ...
) ENGINE = MergeTree ORDER BY (event_type, repo_name, created_at);</pre>
</section>

<section class="slide">
<pre style="font-size: 45%;">find . -name '*.json.gz' | xargs <b>-P16</b> -I{} bash -c "
gzip -cd {} | <b>jq</b> -c '
[
    .type,
    .actor.login,
    .repo.name,
    .created_at,
    .payload.updated_at // .payload.comment.updated_at // .payload.issue.updated_at // .payload.pull_request.updated_at,
    .payload.action,
    .payload.comment.id,
    .payload.review.body // .payload.comment.body // .payload.issue.body // .payload.pull_request.body // .payload.release.body,
    .payload.comment.path,
    .payload.comment.position,
    .payload.comment.line,
    .payload.ref,
    .payload.ref_type,
    .payload.comment.user.login // .payload.issue.user.login // .payload.pull_request.user.login,
    .payload.issue.number // .payload.pull_request.number,
    .payload.issue.title // .payload.pull_request.title,
    [.payload.issue.labels[]?.name // .payload.pull_request.labels[]?.name],
    .payload.issue.state // .payload.pull_request.state,
    .payload.issue.locked // .payload.pull_request.locked,
    .payload.issue.assignee.login // .payload.pull_request.assignee.login,
    [.payload.issue.assignees[]?.login // .payload.pull_request.assignees[]?.login],
    .payload.issue.comments // .payload.pull_request.comments,
    .payload.review.author_association // .payload.issue.author_association // .payload.pull_request.author_association,
    .payload.issue.closed_at // .payload.pull_request.closed_at,
    .payload.pull_request.merged_at,
    .payload.pull_request.merge_commit_sha,
    [.payload.pull_request.requested_reviewers[]?.login],
    [.payload.pull_request.requested_teams[]?.name],
    ...
    .payload.pull_request.additions,
    .payload.pull_request.deletions,
    .payload.pull_request.changed_files,
    .payload.comment.diff_hunk,
    .payload.comment.original_position,
    .payload.comment.commit_id,
    .payload.comment.original_commit_id,
    .payload.size,
    .payload.distinct_size,
    .payload.member.login,
    .payload.release.tag_name,
    .payload.release.name,
    .payload.review.state
]' | clickhouse-client --input_format_null_as_default 1 --date_time_input_format best_effort --query '
    INSERT INTO github_events FORMAT JSONCompactEachRow' || echo 'File {} has issues'
"</pre>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Loading GitHub Data into ClickHouse</h2>
<p>What we got:</p>
<p>One flat table with all event types.</p>
<p>Many columns &mdash; different properties of different events.</p>
<p>Easy to analyze different events without JOIN.</p>
<pre>SELECT
    sum(event_type = 'WatchEvent') AS stars,
    sum(event_type = 'PullRequestEvent'
        AND action = 'opened') AS prs
FROM github_events
GROUP BY repo_name</pre>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Loading GitHub Data into ClickHouse</h2>
<img style="float: left; height: 60%; margin-left: -60px; margin-top: -75px; margin-right: 20px;" src="pictures/optimal.webp"/>
<p>What we got:</p>
<p>&mdash; 2.5 billion rows;<br/>
&mdash; 150 GB compressed;<br/>
&mdash; 140 million repositories;<br/>
&mdash; queries run in seconds.</p>
<p style="margin-top: 2em;">Conclusion:</p>
<p>All events in all repositories throughout GitHub history:<br/>
&mdash; is not "Big Data";<br/>
&mdash; is <span style="color: green;">"Fits on Your Laptop"</span> Data.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">GitHub Data in ClickHouse</h2>
<p>Can quickly answer almost any question<br/>about the Open-Source ecosystem*:</p>
<p style="font-size: 90%; line-height: 1.5;">
&mdash; top repositories by stars, all time, this year;<br/>
&mdash; fastest growing for the quarter or stagnating among large repositories;<br/>
&mdash; graphs of star count, issues, contributors for any repository;<br/>
&mdash; most prolific code authors;<br/>
&mdash; who does the most code review;<br/>
&mdash; repositories with the most comment activity;<br/>
&mdash; all repositories related to ClickHouse;<br/>
&mdash; all my comments... and others' too.</p>
<p style="color: gray; font-size: 80%">* about the part available on GitHub.</p>
</section>

<!-- TODO demo -->

<section class="slide">
<h2 style="font-size: 30pt;">Conclusions</h2>
<p>To analyze data, you need to:</p>
<p>&mdash; study the source model and nature of the data;<br/>
&mdash; choose the right representation for analysis;<br/>
&mdash; perform data preparation and cleaning;<br/>
&mdash; cut corners where possible;<br/>
&mdash; be able to write a simple script in any language;<br/>
&mdash; never be afraid of big data;<br/>
&mdash; investigate outliers and data internals;<br/>
&mdash; be ready to throw everything away and start over;<br/>
&mdash; never stop at one report;</p>
<p
>... and you'll also need courage.</p>
</section>

<section class="slide">
<h2>.</h2>
</section>

    <div class="progress"></div>
    <script src="shower/shower.min.js"></script>

    <!--Video plugin-->
    <link rel="stylesheet" href="shower/shower-video.css">
    <script src="shower/shower-video.js"></script>
    <!--/Video plugin-->
</body>
</html>
