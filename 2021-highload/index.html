<!DOCTYPE html>
<html lang="en">
<head>
    <title>Unusual Cases of Performance Optimization Using ClickHouse as an Example</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:image" content="pictures/preview.jpg">
    <meta property="og:title" content="Unusual Cases of Performance Optimization Using ClickHouse as an Example">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="pictures/preview.jpg">
    <link rel="stylesheet" href="https://presentations.clickhouse.com/shower/themes/clickhouse/styles/styles.css">
</head>
<body class="shower list">
    <header class="caption">
        <h1>Unusual Cases of Performance Optimization Using ClickHouse as an Example</h1>
        <p>Author: Alexey Milovidov, 2021-05-11.</p>
    </header>

    <section class="slide" id="cover" style="background: #FFF url('pictures/title.png') no-repeat; background-size: 100%;">
        <h1 style="margin-top: 50px; font-size: 32pt; color: white;">Unusual Cases of Performance<br/>Optimization<br/>Using ClickHouse as an Example</h1>
    </section>

    <section class="slide">
        <h2>About Me</h2>
        <p>Alexey, ClickHouse developer.</p>
    </section>

    <section class="slide">
        <h2>ClickHouse</h2>
        <p><ul>
            <li>didn't slow down;</li>
            <li>doesn't slow down;</li>
            <li>will not slow down even more.</li>
        </ul></p>
    </section>

    <section class="slide">
        <h2>Performance Optimization</h2>
        <img style="float: right; width: 30%;" src="pictures/whack_a_mole.jpg" />
        <p>Profiling under different workloads.</p>
        <p>Optimizing everything that pops up.</p>
        <p style="color: gray; font-size: 75%; margin-top: 200px;">About performance testing &mdash; see Alexander Kuzmenkov's talk tomorrow at 10 AM.</p>
        <p style="float: right; color: gray; font-size: 40%;">https://www.techdesignforums.com/practice/technique/<br/>winning-at-whac-a-mole-redesigning-an-rf-transceiver/</p>
    </section>

    <section class="slide">
        <h2>Episode 1: MergeTree vs Memory</h2>
        <p>ClickHouse has different &laquo;table engines&raquo;.</p>
        <p><b>MergeTree</b> tables store data on disk.</p>
        <p><b>Memory</b> tables store data in RAM.</p>

        <p>Memory is faster than disks*.</p>
        <p>Does this mean Memory tables are faster than MergeTree?</p>

        <p style="color: gray; font-size: 75%; margin-top: 50px;">* What does &laquo;faster&raquo; mean? Sequential read and write speed. Random read and write latency. IOPS at given parallelism and load distribution.</p>
        <p style="color: gray; font-size: 75%;">Of course memory can be slower than disk subsystem,<br/>for example single-channel memory vs. 10x PCIe 4.0 SSDs.</p>
    </section>

    <!--
        SELECT SearchPhrase, count() AS c FROM test.hits GROUP BY SearchPhrase ORDER BY c DESC LIMIT 10;
        CREATE TABLE test.hits_memory AS test.hits ENGINE = Memory;
        SET max_memory_usage = '20G';
        INSERT INTO test.hits_memory SELECT * FROM test.hits;
        SELECT SearchPhrase, count() AS c FROM test.hits_memory GROUP BY SearchPhrase ORDER BY c DESC LIMIT 10;
        -->

    <section class="slide">
        <video style="height: 100%; margin-top: -10px; margin-left: -80px; margin-right: -80px;"><source src="video/mergetree_vs_memory.mp4" type="video/mp4"></video>
    </section>

    <section class="slide">
        <h2>MergeTree vs Memory</h2>
        <p><b>Memory</b> tables store data in RAM.</p>
        <p><b>MergeTree</b> tables store data on disk,<br/>more precisely in the file system.</p>
        <p>But data from the file system goes into <b>page cache</b>.</p>
        <p>And then is read <span style="color: green;">from RAM</span>.</p>

        <p>Does this mean there's no difference between <b>Memory</b> and <b>MergeTree</b> tables
        <br/>when data is in page cache?</p>
    </section>

    <section class="slide">
        <h2>MergeTree vs Memory</h2>
        <p>Obvious cases when <b>MergeTree</b> is faster than <b>Memory</b>.</p>
        <p><b>MergeTree</b> tables have a primary key and secondary indexes,<br/>and allow reading only the necessary data ranges.</p>
        <p><b>Memory</b> tables only allow full scan.</p>

        <p style="color: gray;">But this case is not interesting.</p>

        <p style="color: green;">Can MergeTree be faster than Memory in full scan?</p>
    </section>

    <!-- clickhouse-benchmark <<< "SELECT SearchPhrase, any(replaceAll(substring(URL, 1, 100), 'google', 'yandex')) AS s, count() AS c FROM test.hits GROUP BY SearchPhrase ORDER BY c DESC LIMIT 10" -->

    <section class="slide">
        <video style="width: 100%;"><source src="video/memory_is_slower.mp4" type="video/mp4"></video>
    </section>

    <section class="slide">
        <h2>MergeTree vs Memory</h2>
        <p>Non-obvious cases when <b>MergeTree</b> is faster than <b>Memory</b>.</p>
        <p><b>MergeTree</b> tables store data in sorted order<br/>by primary key.</p>
        <p>Some algorithms in ClickHouse exploit<br/>data locality advantages when available (fast path).</p>

        <p>For example, if during GROUP BY the same value occurs
        <br/>twice in a row, we don't do a repeated lookup in the hash table.</p>

        <p style="color: gray; font-size: 75%;">About hash tables in ClickHouse, see Maxim Kita's talk tomorrow at 12:50.</p>

        <p style="color: green;">And if data in tables is in the same order,<br/>can MergeTree be faster than Memory?</p>
    </section>

    <!-- Example about ClientIP and RegionID -->

    <section class="slide">
        <h2 style="font-size: 32pt;">How Data is Processed in ClickHouse</h2>
        <p>Data in ClickHouse is stored by columns
        <br/>and is also processed by columns.</p>

        <table>
            <thead>
                <th>Array of Structures</th>
                <th style="padding-left: 1em;">Structure of Arrays</th>
            </thead>
            <tr>
                <td style="background-color: #FEE;">
        <pre>struct Point3d
{
    float x;
    float y;
    float z;
};
std::vector&lt;Point3d> points;</pre>
                </td>
                <td style="background-color: #EFE; padding-left: 1em;">
        <pre>struct Points
{
    std::vector&lt;float> x;
    std::vector&lt;float> y;
    std::vector&lt;float> z;
};</pre>
                </td>
            </tr>
        </table>
    </section>


    <section class="slide">
        <h2 style="font-size: 32pt;">How Data is Processed in ClickHouse</h2>
        <p>Data in ClickHouse is stored by columns
        <br/>and is also processed by columns. <b style="color: green;">By chunks of columns</b>.</p>

        <pre>struct Chunk
{
    std::vector&lt;float> x;
    std::vector&lt;float> y;
    std::vector&lt;float> z;
};

<b style="color: green;">std::vector&lt;Chunk> chunks;</b>
</pre>
    <p>&mdash; <b>Morsel-based processing</b>.</p>
    </section>


    <section class="slide">
        <h2 style="font-size: 32pt;">How Exactly is Data Read from the Table?</h2>
        <img style="float: right; height: 70%; margin-top: -70px; margin-right: -80px;" src="pictures/not_optimal.webp" />
        <p>In the case of <b>MergeTree</b>:</p>
        <p>&mdash; read compressed files from the file system;</p>
        <p>&mdash; calculate and verify checksums;</p>
        <p>&mdash; decompress compressed blocks;</p>
        <p>&mdash; deserialize column chunks;</p>
        <p>&mdash; process them;</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">How Exactly is Data Read from the Table?</h2>
        <img style="float: left; height: 70%; margin-top: -70px; margin-left: -80px;" src="pictures/optimal.webp" />
        <p>In the case of <b>Memory</b>:</p>
        <p>&mdash; ready-made column chunks are<br/>&emsp; already in RAM,</p>
        <p>&emsp; process them;</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">What Exactly Happens During Reading?</h2>
        <p style="margin-top: -1em;">In the case of <b>MergeTree</b>:</p>
        <p>1. Read compressed files from the file system:</p>
        <p>&mdash; reading can be done with synchronous (<b>read</b>/<b>pread</b>, <b>mmap</b>)<br/>&emsp; or asynchronous (<b>AIO</b>, <b>uring</b>) I/O;</p>
        <p>&mdash; in case of synchronous I/O, we can<br/>&emsp; use (regular read or mmap)<br/>&emsp; or not use page cache (<b>O_DIRECT</b>);</p>
        <p>&mdash; if reading from page cache without mmap,<br/>&emsp; there will be <span style="color: red;">copying</span> from page cache to userspace;</p>
        <p>&mdash; reading compressed data &mdash; if compression ratio is large,<br/>&emsp; the proportion of time in query processing is small;</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">What Exactly Happens During Reading?</h2>
        <p style="margin-top: -1em;">In the case of <b>MergeTree</b>:</p>
        <p>2. Decompress compressed blocks:</p>
        <p>&mdash; by default LZ4* is used;</p>
        <p>&mdash; you can choose a stronger compression method (ZSTD),<br/>&emsp; or weaker, for example no compression at all (NONE);</p>
        <p>&mdash; sometimes NONE unexpectedly works slower, why would that be?</p>
        <p>&mdash; and what block size was used for compressing data?<br/>&emsp; and how does this affect speed?</p>

        <p style="color: gray; font-size: 75%; margin-top: 50px;">* See the talk &laquo;How to Speed Up LZ4 Decompression&raquo; from HighLoad++ Siberia 2018.</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">What Exactly Happens During Reading?</h2>
        <p>In the case of <b>MergeTree</b>:</p>
        <p>3. Deserialize column chunks:</p>
        <p>&mdash; there is no deserialization as such;</p>
        <p>&mdash; it's just moving data (memcpy);</p>
        <p>&mdash; why is it necessary to move data at all?</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Difference Between MergeTree and Memory</h2>
        <p>In the case of <b>Memory</b>:<br/>&mdash; ready-made column chunks in RAM.</p>
        <p>In the case of <b>MergeTree</b>:<br/>&mdash; column chunks are formed dynamically during reading.</p>
        <p><b>MergeTree</b> does more work,<br/>but can this sometimes be more optimal?</p>
    </section>

    <section class="slide">
        <h2>MergeTree vs Memory</h2>
        <p>In the case of <b>MergeTree</b>:</p>
        <p>&mdash; column chunks are formed dynamically during reading,
        <br/>&emsp; and their size in rows can be chosen adaptively
        <br/>&emsp; for <span style="color: green;">cache locality</span>!</p>
    </section>

    <!-- SELECT round(avg(blockSize())) FROM test.hits WHERE NOT ignore(URL, SearchPhrase) -->

    <section class="slide">
        <h2>Cache Locality</h2>
        <p><b>What speed does RAM work at?</b>
        <br/>&mdash; which RAM, on which machine?</p>
        <p><b>What speed does cache work at?</b>
        <br/>&mdash; which cache level, on which CPU?
        <br/>&mdash; one or all together?</p>
        <p><b>What speed of what?</b>
        <br/>&mdash; throughput, latency?..</p>
    </section>

    <section class="slide">
        <h2>Episode 2: does data compression slow things down?</h2>
        <p>In ClickHouse data is stored compressed by default.</p>
        <p>It's compressed on write, decompressed on read.</p>
        <p>Profiling queries...</p>
        <p>At the top by CPU &mdash; LZ4_decomress_safe function.</p>
        <p style="margin-top: 2em;">To speed everything up, should we just remove data compression?</p>
    </section>

    <section class="slide">
        <img src="pictures/classic.jpg" style="height: 90%;" />
        <p style="font-size: 10pt; color: gray;">Megg, Mogg &amp; Owl Series by Simon Hanselmann</p>
    </section>

    <section class="slide">
        <h2>Trying to Remove Data Compression</h2>
        <img style="float: right; width: 20%; margin-right: -80px;" src="pictures/frustration.jpg" />
        <p style="color: red;">But nothing good comes of it:</p>
        <p>1. Removed data compression and now it doesn't fit on disk.</p>
        <p>2. Removed data compression and now reading from disk is slow.</p>
        <p>3. Removed data compression and now<br/>&emsp;less data fits in page cache.</p>
        <p>...</p>
        <p>But even if uncompressed data fits entirely<br/>in RAM &mdash; <b>does it make sense to not compress</b> it?</p>
    </section>

    <!-- Example -->

    <section class="slide">
        <h2 style="font-size: 32pt;">What's Faster: Decompression or memcpy?</h2>
        <p>The <b>memcpy</b> function is used as a baseline<br/> of the weakest compression or decompression in benchmarks.</p>
        <p>Of course, this is the fastest benchmark for comparison.</p>
        <p>Example:
        <br/>&mdash; memcpy: <b style="color: green;">12 GB</b> per second.
        <br/>&mdash; LZ4 decompression: <b style="color: red;">2..4 GB</b> of decompressed data per second.</p>
        <p>Conclusion: is memcpy faster than LZ4 decompression?</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">What's Faster: Decompression or memcpy?</h2>
        <p>Consider the scenario:</p>
        <p style="line-height: 1.5">&mdash; data is stored in RAM;
        <br/>&mdash; data is processed in blocks;
        <br/>&mdash; each block is quite small and fits in CPU cache;
        <br/>&mdash; processing of each block fits in CPU cache;
        <br/>&mdash; <b style="color: green;">data is processed in multiple threads</b>;</p>

        <p>Data is read from RAM, then only CPU cache is used.</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">What's Faster: Decompression or memcpy?</h2>
        <p>Example: Ryzen 3950 (16 cores)</p>
        <p style="line-height: 1.5">&mdash; memcpy: 16×12 GB = <b>192 GB</b> per second.
        <br/>&mdash; LZ4 decompression: 16×2..4 GB = <b>32..48 GB</b> of decompressed data per second.
        <br/>&mdash; memory read speed: <b style="color: red;">30 GB</b>* per second.
        </p>

        <p>In the case of memcpy, reading is limited by memory speed.</p>
        <p><span style="color: green;">But if compression is used, less data is read from memory.</span>
        <br/><b>Memory works like disk.</b> Is LZ4 decompression faster than memcpy?</p>

        <p style="color: gray; font-size: 75%;">* dual-channel memory, but not working at maximum frequency.<br/>According to specs for this CPU up to 48 GB per second.</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">What's Faster: Decompression or memcpy?</h2>
        <p>Example: 2 × AMD EPYC 7742 (<b>128 cores</b>)</p>
        <p>8 channel memory, max throughput <b>190 GiB/s</b></p>

        <p>For this server, working with data<br/>compressed with LZ4, will also be faster.</p>
        <p>But if there are fewer cores &mdash; it's not so clear anymore.</p>
        <p style="color: gray;">If data is well compressed, decompression still hits CPU,<br/> which means it can be sped up!</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Optimizations in ClickHouse</h2>
        <p style="margin-top: -1em;">For <b>Memory</b> tables:</p>
        <p>&mdash; Reduced block size on write<br/>for better cache locality of data processing <a href="https://github.com/ClickHouse/ClickHouse/pull/20169">#20169</a>.</p>
        <p>&mdash; Ability to compress Memory tables <a href="https://github.com/ClickHouse/ClickHouse/pull/20168">#20168</a>.</p>
        <p>For <b>MergeTree</b> tables:</p>
        <p>&mdash; Removed unnecessary copying for NONE compression mode <a href="https://github.com/ClickHouse/ClickHouse/pull/22145">#22145</a>.</p>
        <p>&mdash; Ability to disable checksums when reading <a href="https://github.com/ClickHouse/ClickHouse/pull/19588">#19588</a>,<br/>but this ability should not be used.</p>
        <p>&mdash; Ability to read using mmap <a href="https://github.com/ClickHouse/ClickHouse/pull/8520">#8520</a>, to remove<br/>unnecessary copying from page cache and also cache memory mappings <a href="https://github.com/ClickHouse/ClickHouse/pull/22206">#22206</a>.</p>
    </section>

    <!--
        SELECT SearchPhrase, any(replaceAll(substring(URL, 1, 100), 'google', 'yandex')) AS s, count() AS c FROM test.hits GROUP BY SearchPhrase ORDER BY c DESC LIMIT 10
        SELECT SearchPhrase, any(replaceAll(substring(URL, 1, 100), 'google', 'yandex')) AS s, count() AS c FROM test.hits_memory GROUP BY SearchPhrase ORDER BY c DESC LIMIT 10
        DROP TABLE test.hits_memory
        CREATE TABLE test.hits_memory AS test.hits ENGINE = Memory SETTINGS compress = 1;
        INSERT INTO test.hits_memory SELECT * FROM test.hits;
        SELECT SearchPhrase, any(replaceAll(substring(URL, 1, 100), 'google', 'yandex')) AS s, count() AS c FROM test.hits_memory GROUP BY SearchPhrase ORDER BY c DESC LIMIT 10
        -->

    <section class="slide">
        <video style="width: 100%;"><source src="video/memory_compressed_slower.mp4" type="video/mp4"></video>
    </section>

    <section class="slide">
        <video style="width: 100%;"><source src="video/memory_compressed_faster.mp4" type="video/mp4"></video>
    </section>

    <section class="slide">
        <h2>Conclusions</h2>
        <p>To optimize performance, you just need to:</p>
        <p>&mdash; know exactly what your code does;</p>
        <p>&mdash; profile the system under realistic load scenarios;</p>
        <p>&mdash; understand hardware capabilities;</p>
        <p>...</p>
        <p>&mdash; not forget that the system has many cores, and the processor has cache;<br/>&emsp; don't confuse latency and throughput :)</p>
    </section>

    <section class="slide">
        <h2>Thank you!</h2>
    </section>


    <div class="progress"></div>
    <script src="https://presentations.clickhouse.com/shower/shower.js"></script>

    <!--Video plugin-->
    <link rel="stylesheet" href="https://presentations.clickhouse.com/shower/shower-video.css">
    <script src="https://presentations.clickhouse.com/shower/shower-video.js"></script>
    <!--/Video plugin-->
<footer class="badge">
    <a href="https://presentations.clickhouse.com/">ClickHouse Theater</a>
</footer>
</body>
</html>
