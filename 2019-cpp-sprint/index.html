<!DOCTYPE html>
<html lang="en">
<head>
    <title>How to Become a ClickHouse Developer</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:image" content="pictures/preview.jpg">
    <meta property="og:title" content="How to Become a ClickHouse Developer">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="pictures/preview.jpg">
    <link rel="stylesheet" href="https://presentations.clickhouse.com/shower/themes/clickhouse/styles/styles.css">
    <style>
        code { display: block; white-space: pre; background-color: #EEE; }
        .shower { --slide-ratio: calc(16 / 10); }
        pre { line-height: 1; }
    </style>
</head>
<body class="shower list">
    <header class="caption">
        <h1>How to Become a ClickHouse Developer</h1>
    </header>

    <section class="slide" id="cover">
        <h1 style="margin-top: 150px; font-size: 40pt;">How to Stop Being Afraid<br/>and Become a ClickHouse Developer</h1>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Where to Find ClickHouse Developers</h2>
        <p><img style="height: 230px;" src="pictures/kochetov.png"/><img style="height: 230px;" src="pictures/sapin.jpg"/><img style="height: 230px;" src="pictures/proller.jpg"/><img style="height: 230px;" src="pictures/milovidov.jpg"/></p>
        <p>Here!</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Where to Find ClickHouse Developers</h2>
        <p style="margin-top: -25px;"><img style="height: 500px;" src="pictures/github_contributors.png"/></p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Where to Find ClickHouse Developers</h2>
        <pre>:) SELECT * FROM system.contributors

┌─name──────────────────────────────────┐
│ Olga Khvostikova                      │
│ abdrakhmanov                          │
│ Mikhail Filimonov                     │
│ Jason                                 │
│ achulkov2                             │
│ Veniamin Gvozdikov                    │
  ...
│ Artemeey                              │
│ ivanzhukov                            │
│ Ilya Khomutov                         │
└───────────────────────────────────────┘

303 rows in set.</pre>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">How to Become a ClickHouse Developer</h2>
        <p>You need to know <b>C++</b>.</p>
        <p>... not necessarily
        <br/>&mdash; to get into system.contributors, one commit is enough;
        <br/>&mdash; you can fix a typo in a comment.</p>
        <p><img style="height: 300px;" src="pictures/misspells.png"/></p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">How to Become a ClickHouse Developer</h2>
        <p>You can add a test. You can add a bug.</p>
    <pre style="line-height: 1.25; font-size: 16pt;">commit 531560a6a5c2f177213a0761b1f3595b0730318a
Author: Alexey Milovidov &lt;milovidov@yandex-team.ru&gt;
Date:   Sun Dec 30 06:22:05 2018 +0300

    Added bug [#CLICKHOUSE-3695]

diff --git a/dbms/tests/queries/bugs/remote_scalar_subquery.sql
new file mode 100644
+++ b/dbms/tests/queries/bugs/remote_scalar_subquery.sql

<span style="color: green;">+SELECT (SELECT 1) FROM remote('127.0.0.{1,2}', system.one);</span></pre>
    </section>

    <section class="slide">
        <h2 style="font-size: 31pt;">But Still Better to Know C++</h2>
        <p><img style="float: left; height: 400px;" src="pictures/qr.gif">
        <div style="line-height: 1.5; margin-top: 60px;">&mdash; cloning the repository;<br/>
        &mdash; building the project;<br/>
        &mdash; local launch;<br/>
        &mdash; code style;<br/>
        &mdash; writing tests;<br/>
        &mdash; architecture description;<br/>
        </div></p>
    </section>

    <section class="slide">
<h2>ClickHouse Architecture</h2>
</section>

    <section class="slide">
<h2>The Foundation of ClickHouse is Columns</h2>

<p>On disk &mdash; columns.<br/>
Data is stored by columns.</p>

<p>In RAM &mdash; columns.<br/>
Data is processed by columns.</p>
</section>


<section class="slide">
<h2>How Columns are Stored in RAM</h2>

<p>As chunks of columns &mdash; for example, 65,536 elements.</p>
<p>Chunk size &mdash; depends on many things.</p>
<p>For SELECT &mdash; see the max_block_size setting.</p>
</section>


<section class="slide">
<h2>How Columns are Stored in RAM</h2>
<p>Represented as objects with the IColumn interface.</p>
<p>Variants &mdash; ColumnVector&lt;T&gt;, ColumnString, ColumnArray...</p>

<p>ColumnVector&lt;T&gt; &mdash; almost like std::vector&lt;T&gt;.<br/>
But under the IColumn interface.<br/>
And instead of std::vector&lt;T&gt; &mdash; PODArray&lt;T&gt; (why?).</p>
</section>


<section class="slide">
<h2>How Columns are Stored in RAM</h2>
<p>Previously it was std::vector. PODArray &mdash; is just an optimization.</p>
</section>


<section class="slide">
<h2>How Columns are Stored in RAM</h2>

<p>ColumnString &mdash; consists of two components:</p>

<p>1. Bytes laid out sequentially.<br/>
2. Offsets to the i+1 string.</p>

<code>h e l l o \0 w o r l d \0
6 12</code>
</section>


<section class="slide">
<h2>How Columns are Stored in RAM</h2>

<p>ColumnConst</p>

<p>Made of one nested column,<br/>
containing one value.</p>
</section>


<section class="slide">
<h2>What the IColumn Interface Provides</h2>

<p>Basic operations:<br/>
&mdash; cut &mdash; extract part of a column, for LIMIT implementation;<br/>
&mdash; filter &mdash; for WHERE implementation;<br/>
&mdash; compareAt, permute &mdash; for ORDER BY implementation;<br/>
...</p>
</section>


<section class="slide">
<h2>How Columns are Stored in RAM</h2>

<p>Ownership &mdash; using COWPtr&lt;IColumn&gt;.</p>
<p>Previously it was std::shared_ptr&lt;IColumn&gt;.</p>
</section>


<section class="slide">
<h2>Almost All Operations are Immutable</h2>

<p>virtual <b>Ptr</b> filter(const Filter &amp; filt, ssize_t result_size_hint) <b>const</b> = 0;</p>

<p>Instead of modifying contents, they create<br/>and return a new column object.</p>

<p>This is normal, since operations are "coarse-grained".</p>

<p>But there are also "fine-grained", mutating operations.</p>
</section>


<section class="slide">
<h2>IColumn, what it's responsible for:</h2>

<p>&mdash; storing data in RAM;<br/>
&mdash; common operations on columns.</p>

<h2>IColumn, what it's similar to:</h2>

<p>&mdash; Apache Arrow;<br/>
&mdash; arrays in NumPy;<br/>
&mdash; arrays in APL, J, K.</p>
</section>


<section class="slide">
<h2>Motivation</h2>

<p>Isolate maximally efficient<br/>inner loops from wrapper code.</p>
<p>Code doesn't have to be efficient as a whole.</p>
<p>Optimizable places should be localizable.</p>

<p><b>&laquo;vectorized engine&raquo;</b></p>

<p>Bonus:<br/>
&mdash; SIMD instructions;<br/>
&mdash; clever optimizations for homogeneous data<br/>
(IColumn::filter, LIKE function implementation);</p>
</section>


<section class="slide">
<h2>Data Types:</h2>

<p>IDataType</p>

<p>&mdash; binary serialization and deserialization to data streams;<br/>
&mdash; one column can be written to multiple physical streams, example: Array(Array(UInt8));<br/>
&mdash; serialization and deserialization in text form for different data formats;<br/>
&mdash; properties of the data type;<br/>
&mdash; completely immutable: std::shared_ptr&lt;<b>const</b> IDataType&gt;.</p>

<code>  DataTypeUInt32 \ / ColumnUInt32
                  X
DataTypeDateTime / \ ColumnConst(ColumnUInt32)</code>
</section>


<section class="slide">
<h2>Block</h2>

<p>A chunk of a table: a set of { ColumnPtr, DataTypePtr, name }</p>

<p>Data processing in the query execution pipeline<br/>is performed over blocks.</p>

<p>... there's an architectural mistake here that needs to be fixed.</p>
</section>


<section class="slide">
<h2>Block</h2>

<p>Should be split into</p>

<p>Header: set of { ColumnPtr, DataTypePtr, name }<br/>
Block: { size_t num_rows, std::vector&lt;ColumnPtr&gt;, properties... }</p>
</section>


<section class="slide">
<h2>Block Streams</h2>

<p>IBlockInputStream: Block read();<br/>
IBlockOutputStream: void write(Block);</p>

<p>Implement:<br/>
&mdash; data formats (CSV, JSON, Native...)<br/>
&mdash; reading and writing to tables;<br/>
&mdash; transformations on data (Limit, Filter, Expression, ...)</p>

<p>Strongly typed &mdash; blocks have the same data types<br/><em>and constant values</em>.</p>
</section>


<section class="slide">
<h2>Table Engines</h2>

<p>Interface &mdash; IStorage.<br/>
Implementations &mdash; StorageMemory, StorageMergeTree...<br/>
Class instances &mdash; are tables.</p>

<code>virtual <b>BlockInputStreams</b> read(
    const Names &amp; /*column_names*/,
    const SelectQueryInfo &amp; /*query_info*/,
    const Context &amp; /*context*/,
    QueryProcessingStage::Enum &amp; /*processed_stage*/,
    size_t /*max_block_size*/,
    unsigned /*num_streams*/)</code>
</section>


<section class="slide">
<h2>Query Execution Pipeline</h2>

<p>It's just a BlockInputStream (for SELECT)<br/>or BlockOutputStream (for INSERT),<br/>
that performs all necessary transformations<br/>when calling the read or write method.</p>

<p>Question &mdash; what pipeline for INSERT SELECT?</p>
</section>


<section class="slide">
<h2>Query Execution Pipeline</h2>

<p style="margin-top: -20px;">SELECT works on the pull principle, INSERT on the push principle.</p>

<p>In reality this &mdash; is an architectural mistake.</p>
</section>


<section class="slide">
<h2>Lexer, Parser, AST</h2>

<p>Parser &mdash; manual recursive descent parser.</p>

<p>ClickHouse parser features:<br/>
&mdash; Nested columns;<br/>
&mdash; lambda functions;<br/>
&mdash; aliases and expressions anywhere in the query;</p>
</section>


<section class="slide">
<h2>Query Analysis and Optimization</h2>

<p>InterpreterSelectQuery<br/>
ExpressionAnalyzer</p>

<p>Most &mdash; rule based optimizations:<br/>
&mdash; constant folding;<br/>
&mdash; gluing identical expressions;<br/>
&mdash; removing unnecessary computations;<br/>
&mdash; removing unnecessary columns;<br/>
...<br/>
&mdash; pushing ARRAY JOIN closer to the end;<br/>
&mdash; turning chains of OR into IN;</p>

<p>Need to rewrite everything :)</p>
</section>


<section class="slide">
<h2>Functions</h2>

<p>Work over an entire block at once.<br/>
The code implements not a single function application,<br/> but an entire loop over arrays.</p>
<p>The inner loop (usually) is its own<br/>for each combination of argument types.</p>
<p>Inside the loop (usually) there are no virtual calls,<br/>type checks, extra branches.</p>
</section>


<section class="slide">
<h2>Functions</h2>

<p>Example: for the addition operator there are</p>

<p><code style="font-size: 90%">UInt8 UInt16 UInt32 UInt64     UInt8 UInt16 UInt32 UInt64
    Int8 Int16 Int32 Int64  ✕  Int8 Int16 Int32 Int64
           Float32 Float64     Float32 Float64</code></p>

<p>combinations.</p>

<p>And one of the arguments can be constant:<br/>10 * 10 * 3 = 300 implementations.</p>
</section>


<section class="slide">
<h2>Aggregate Functions</h2>

<p>IAggregateFunction</p>

<p><b>create</b> &mdash; initialize state<br/>in a pre-prepared chunk of memory;</p>

<p><b>add</b> &mdash; update state by argument values;<br/>
<b>merge</b> &mdash; glue two states into one;</p>

<p><b>serialize</b>, <b>deserialize</b><br/>&mdash; write to an input-output stream (network, file, table)</p>

<p><b>insertResultInto</b> &mdash; get the final value.</p>

<p>Aggregate function state is a first class citizen in ClickHouse!</p>
</section>

<section class="slide">
<h2>Project Structure</h2>

<p>Main DBMS code &mdash; in the <b>dbms/src</b> directory.</p>
<p>Programs (client, server) &mdash; in the <b>dbms/programs</b> directory.</p>
<p>Advice: always start reading code from <b>.h</b> files<br/>&mdash; they contain interface descriptions and more comments.</p>
</section>

<section class="slide">
<h2>Project Structure</h2>

<p style="margin-top: -50px;"><img style="width: 80%" src="pictures/project_tree.png"></p>
</section>

    <section class="slide">
        <img src="pictures/adventure.jpg" style="width: 100%; margin-top: 50px;" />
        <p style="font-size: 8pt; color: #888; text-align: right;">&laquo;Rick and Morty&raquo;, ep. &laquo;Rest and Ricklaxation&raquo;, Justin Roiland and Dan Harmon, 2017</p>
    </section>

<section class="slide">
<h2>Medium Complexity Tasks</h2>
<p>For those who have already committed or tried to commit to ClickHouse.</p>
</section>

<section class="slide">
<h2>Try pdqsort or vergesort</h2>
<p>... for full comparison based sorting.</p>
<p>In case when there's ORDER BY without LIMIT, this may slightly increase performance.</p>
<p>Look at <b>sortBlock</b> functions, and also implementations of <b>IColumn::getPermutation</b>.
</section>

<section class="slide">
<h2>Hints in Factories</h2>
<p>... for fixing typos.</p>
<p><code>SELECT fomatReadableSize(bytes) FROM table</code></p>
<p>did you mean <b>formatReadableSize</b>?</p>
</section>

<section class="slide">
<h2 style="font-size: 32pt;">Generic Version of least and greatest Functions</h2>
<p><code>SELECT least(123, 456)</code>
<p>&mdash; works.</p>
<p><code>SELECT least('123', '456')</code>
<p>&mdash; doesn't work.</p>
<p>Implement using <b>IColumn::compareAt</b> for identical types<br/>
and using <b>castColumn</b>, <b>getLeastSuperType</b> for different ones.</p>
</section>

<section class="slide">
<h2 style="font-size: 32pt;">Functions randomFixedString,</h2>
<p>randomBinaryString, and also fuzzBits, fuzzBytes.</p>
</section>

<section class="slide">
<h2 style="font-size: 32pt;">Layout "direct" for Dictionaries</h2>
<p>Like cache, but without caching &mdash; always direct query to source.</p>
</section>

<section class="slide">
<h2 style="font-size: 32pt;">Type Casting for IN (subquery)</h2>
<p><code>SELECT 1 IN (SELECT -1 UNION ALL SELECT 1)</code></p>
</section>

<section class="slide">
<h2>Simple Tasks</h2>
<p>For those who want to make their first commit to ClickHouse.</p>
</section>

<section class="slide">
<h2>Simple Tasks</h2>
<p>Empty --password parameter in the client should mean --ask-password.</p>
<p>NOT BETWEEN operator.</p>
<p>HTTP header query_id.</p>
<p>Decrease max_memory_usage and cache sizes on startup.</p>
<p>Bitwise operations for FixedString.</p>
<p>Add topKWeighted aggregate function.</p>
<p>...</p>
</section>

    <section class="slide">
        <h2 style="font-size: 31pt;">All Tasks</h2>
        <p><img style="margin-left: -30px; float: left; height: 400px;" src="pictures/qr_tasks.gif">
        <div style="line-height: 1.5; margin-top: 60px;">&mdash; simple;<br/>
        &mdash; and not only.<br/>
        <a href="https://github.com/ClickHouse/ClickHouse/blob/master/dbms/tests/instructions/easy_tasks_sorted_ru.md">https://github.com/ClickHouse/ClickHouse/blob/master/dbms/tests/instructions/easy_tasks_sorted_ru.md</a>
        </div></p>
    </section>

    <div class="progress"></div>
    <script src="https://presentations.clickhouse.com/shower/shower.js"></script>

    <!--Video plugin-->
    <link rel="stylesheet" href="https://presentations.clickhouse.com/shower/shower-video.css">
    <script src="https://presentations.clickhouse.com/shower/shower-video.js"></script>
    <!--/Video plugin-->
<footer class="badge">
    <a href="https://presentations.clickhouse.com/">ClickHouse Theater</a>
</footer>
</body>
</html>
