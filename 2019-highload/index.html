<!DOCTYPE html>
<html lang="en">
<head>
    <title>Notorious Bugs and How to Avoid Them Using ClickHouse as an Example</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="shower/themes/yandex/styles/screen-16x9.css">
</head>
<body class="shower list">
    <header class="caption">
        <h1>Notorious Bugs and How to Avoid Them Using ClickHouse as an Example</h1>
    </header>

    <section class="slide" id="cover" style="background: #FFF url('pictures/title.png') no-repeat; background-size: 100%;">
        <h1 style="margin-top: 50px; font-size: 32pt; color: white;">Notorious Bugs and How to Avoid Them<br/>Using ClickHouse as an Example</h1>
    </section>

    <section class="slide">
        <h2>About Me</h2>
        <p>Alexey, ClickHouse developer.</p>
    </section>

    <section class="slide">
        <h2>Notorious Bugs</h2>
        <p><ul><li>Bugs in code</li>
        <li>Compiler bugs</li>
        <li>OS kernel bugs</li>
        <li>Hardware bugs</li>
        <li>Configuration bugs</li>
        <li>Usability bugs</li></ul></p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>This example is taken from practice.</p>
        <p>Not mine.</p><p>Very long ago.</p><p>In a completely different company.</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>There is a map-reduce cluster.</p>
        <p>It consists of data-nodes and master.</p>
        <p>Data-nodes store data.</p>
        <p>Data-nodes know the master's address and connect to it.</p>
        <p>Master-node monitors where which data should be located,<br/> and gives commands to data-nodes.</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>Updated the data-nodes configuration on one of the clusters.</p>
        <p>By mistake, data-nodes received the master address from another cluster.</p>
        <p>...</p>
        <p>The master decided that the data-nodes contain some unknown data.</p>
        <p>And gave everyone the command to delete this data.</p>
        <p>When half the data was deleted, someone noticed.</p>
    </section>

    <section class="slide">
        <img src="pictures/classic.jpg" style="height: 90%;" />
        <p style="font-size: 10pt; color: gray;">Megg, Mogg &amp; Owl Series by Simon Hanselmann</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>The most epic bugs &mdash; are those that lead<br/>to unintentional data deletion.</p>
        <p>How to avoid:</p>

        <p>Don't delete data, but set it aside.</p>
        <p><b>Don't delete unexpected data</b> if the reason is unknown.</p>
        <p><b>Threshold on quantity</b> of unexpected data<br/>&mdash; if there's too much, refuse to start.</p>
        <p>Isolation of testing and production at the network level.</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>This example is taken from practice.</p>
        <p>Now mine...</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>One good company had a ClickHouse cluster working strangely.</p>
        <p>During operation, replicas didn't synchronize,<br/>and during restart there was a message<br/>that &laquo;all data is invalid&raquo;, and the server wouldn't start.</p>
        <p>When setting the <b>force_restore_data</b> flag,<br/>part of the data was set aside.</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>ClickHouse cluster uses ZooKeeper for coordination.</p>
        <p>ZooKeeper stores metadata about<br/>which data should be on which replica.</p>
        <p>ZooKeeper &mdash; is also a cluster, typically three machines.</p>
        <p>In ClickHouse configuration all ZooKeeper machines are specified<br/>and connection is established with a random one.</p>
    </section>

    <section class="slide">
        <h2>Configuration Bugs</h2>
        <p>Reason: instead of <b style="color: green;">a cluster of three ZK nodes</b>,<br/> there were <b style="color: red;">three independent nodes</b> (three clusters of one node).</p>
        <p>Solution:<br/>&mdash; fix ZK configuration;<br/>&mdash; execute <b>ATTACH</b> for data parts from directory <b>detached/unexpeted_*</b>.</p>
        <p>Result:<br/>&mdash; <b style="color: green;">all data restored</b>;<br/>&mdash; replicas synchronized;<br/>&mdash; zero loss!</p>
    </section>


    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>Example from 2015.</p>
        <p>This bug manifested in production on Yandex.Metrica cluster...</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>Symptom:</p>
        <p>Very rarely a user gets an exception</p>
        <p>&laquo;<span style="color: red;">Checksum doesn't match, corrupted data</span>&raquo;</p>
        <p>or &laquo;<span style="color: red;">LRUCache became inconsistent. There must be a bug in it</span>&raquo;.</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>&laquo;Checksum doesn't match, corrupted data&raquo;</p>
        <p>&mdash; checksums of compressed data blocks are verified before decompression;</p>
        <p>&mdash; error usually indicates<br/>that data on the file system is corrupted;</p>
        <p>&mdash; but if you read the same file manually, there is no error;</p>
        <p>&mdash; once it appears, the error reproduces consistently when repeating the query;</p>
        <p>&mdash; after server restart, the error disappears for some time.</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>&laquo;Checksum doesn't match, corrupted data&raquo;</p>
        <p>&mdash; maybe data is corrupted in RAM?</p>
        <p>&mdash; but there are no machine check exceptions in <b>dmesg</b> (kern.log);</p>
        <p>&mdash; but otherwise, there are no manifestations of the error;</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>&laquo;LRUCache became inconsistent. There must be a bug in it.&raquo;</p>
        <p>&mdash; here we are clearly told that there's a bug in the code;</p>
        <p>&mdash; possibly memory corruption?</p>
        <p>&mdash; but tests under <b>ASan</b> and <b>TSan</b> in CI show nothing;</p>
        <p>&mdash; and running the server under <b>ASan</b> in production doesn't catch anything :(</p>
        <p>&mdash; flushing mark cache temporarily fixes the error.</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>Looking for the bug by staring at code<br/>and reviewing changes in the latest release.</p>
        <p>Fixed three other bugs, but the problem remains.</p>
        <p>Trying to find patterns by servers,<br/>by time, by load characteristics...</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>The problem manifests only on one of the clusters,<br/>but on others &mdash; never.</p>
        <p>Only on this cluster is a new feature used<br/>&mdash; cache dictionaries.</p>
        <p>Cache dictionaries use a manually written allocator<br/>&mdash; ArenaWithFreeLists.</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
    <code style="display: block; white-space: pre;">class ArenaWithFreeLists
{
    Block * free_lists[16] {};

    static auto sizeToPreviousPowerOfTwo(size_t size)
    {
        return <b style="color: red;">_bit_scan_reverse</b>(size - 1);
    }

    char * alloc(size_t size)
    {
        const auto list_idx = findFreeListIndex(size);
        free_lists[list_idx]->...
    }
}</code>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p style="margin-top: -1em;"><code>int _bit_scan_reverse(int a)</code></p>
        <p style="margin-top: 1em;">Set dst to the index of the highest set bit in 32-bit integer a.<br/>If no bits are set in a then dst is <b>undefined</b>.</p>
        <p>The compiler can use undefined behaviour<br/>to optimize code...</p>
        <p>... but instead it just generates <code>bsr %edi, %eax;</code></p>
        <p>the <code>bsr</code> instruction has undefined behavior at the CPU level,<br/>if the operand is zero.</p>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p>The <code>bsr</code> instruction has undefined behavior at the CPU level,<br/>if the operand is zero.</p>
        <p>In fact, with a zero argument, the processor leaves the destination register unchanged.</p>
        <p>The result depends on how and where the function is inlined by the compiler.</p>
        <p><code style="display: block; white-space: pre;">bsrl %edi, %eax
retq</code></p>
    </section>

    <section class="slide">
    <code style="display: block; white-space: pre; margin: 0 -70px 0 -70px; font-size: 12pt; line-height: 1.5; overflow: hidden;">$ objdump -Cd /usr/bin/clickhouse-server |
    grep -E 'bsr|^000' | grep -B1 bsr | grep -A2 -E 'Cache|Arena'

00000000010f8690 &lt;DB::ArenaWithFreeLists::findFreeListIndex(unsigned long)>:
 10f8694:       0f bd db                <span style="color: green; font-weight: bold;">bsr    %ebx,%ebx</span>
00000000010f99d0 &lt;DB::CacheDictionary::setAttributeValue(DB::CacheDictionary::attribute_t&amp;, unsigned long, DB::Field const&amp;) const>:
 10f9a48:       44 0f bd f2             <span style="color: red; font-weight: bold;">bsr    %edx,%r14d</span>
00000000010f9be0 &lt;DB::CacheDictionary::setDefaultAttributeValue(DB::CacheDictionary::attribute_t&amp;, unsigned long) const>:
 10f9c52:       44 0f bd ea             <span style="color: red; font-weight: bold;">bsr    %edx,%r13d</span>
0000000001a888a0 &lt;DB::ComplexKeyCacheDictionary::setDefaultAttributeValue(DB::ComplexKeyCacheDictionary::attribute_t&amp;, unsigned long) const>:
 1a88917:       45 0f bd e4             <span style="color: green; font-weight: bold;">bsr    %r12d,%r12d</span>
0000000001a88b40 &lt;DB::ComplexKeyCacheDictionary::allocKey(unsigned long, std::vector&lt;DB::IColumn const*, std::allocator&lt;DB::IColumn const*> > const&amp;, std::vector&lt;StringRef, std::allocator&lt;StringRef> >&amp;) const>:
 1a88be9:       45 0f bd ed             <span style="color: green; font-weight: bold;">bsr    %r13d,%r13d</span>
0000000001a88e10 &lt;DB::ComplexKeyCacheDictionary::freeKey(StringRef) const>:
 1a88e5a:       0f bd db                <span style="color: green; font-weight: bold;">bsr    %ebx,%ebx</span>
0000000001a88fd0 &lt;DB::ComplexKeyCacheDictionary::copyKey(StringRef) const>:
 1a89033:       0f bd ed                <span style="color: green; font-weight: bold;">bsr    %ebp,%ebp</span>
0000000001a89780 &lt;DB::ComplexKeyCacheDictionary::setAttributeValue(DB::ComplexKeyCacheDictionary::attribute_t&amp;, unsigned long, DB::Field const&amp;) const>:
 1a897f8:       44 0f bd ea             <span style="color: red; font-weight: bold;">bsr    %edx,%r13d</span>
 1a89929:       45 0f bd e4             <span style="color: green; font-weight: bold;">bsr    %r12d,%r12d</span></code>
    </section>

    <section class="slide">
        <h2>Bugs in Code</h2>
        <p style="margin-top: -1em;">&mdash; take garbage instead of array index;
        <br/>&mdash; get memory corruption somewhere far away;</p>
        <p>&mdash; almost all memory is filled with caches &mdash; corrupted cache;
        <br/>&mdash; this &mdash; is cache of &laquo;marks&raquo;, offsets in files;</p>
        <p>&mdash; read file at wrong offset<br/>&mdash; get garbage instead of checksum;</p>
        <p>&laquo;Checksum doesn't match, corrupted data&raquo;</p>
        <p><a href="https://github.com/ClickHouse/ClickHouse/commit/2368ac36">https://github.com/ClickHouse/ClickHouse/commit/2368ac36</a></p>
        <p style="color: green;">Fixed December 27, 2015</p>
    </section>


    <section class="slide">
        <h2><s>Bugs</s> in Hardware</h2>
        <p>Or rather, inevitable effects.</p>
        <p>&mdash; non-atomicity of writes on RAID;</p>
        <p>&mdash; bit rot on HDD and SSD;</p>
        <p>&mdash; bit flips in RAM (but what about ECC?);</p>
        <p>&mdash; bit flips at the CPU level;</p>
        <p>&mdash; bit flips in network (but what about TCP and Ethernet checksums?)</p>
    </section>

    <section class="slide">
        <h2>Hardware Bugs</h2>
        <p><a href="https://github.com/ClickHouse/ClickHouse/issues/780">https://github.com/ClickHouse/ClickHouse/issues/780</a></p>
        <p>&laquo;A malformed znode prevents ClickHouse from starting&raquo;</p>
        <code style="display: block; white-space: pre; line-height: 1.5; font-size: 14pt;">format version: 3
create_time: 2017-05-04 13:00:44
source repliba: sde500
block_id:
merge
20170501_20170504_200_49083_12589
20170504_20170504_49084_49084_0
into
20170501_20170504_200_49084_12590</code>
    </section>

    <section class="slide">
        <h2>Hardware Bugs</h2>
        <p><a href="https://github.com/ClickHouse/ClickHouse/issues/780">https://github.com/ClickHouse/ClickHouse/issues/780</a></p>
        <p>&laquo;A malformed znode prevents ClickHouse from starting&raquo;</p>
        <code style="display: block; white-space: pre; line-height: 1.5; font-size: 14pt;">format version: 3
create_time: 2017-05-04 13:00:44
source repli<b style="color: red;">b</b>a: sde500
block_id:
merge
20170501_20170504_200_49083_12589
20170504_20170504_49084_49084_0
into
20170501_20170504_200_49084_12590</code>
    </section>

    <section class="slide">
        <h2>Hardware Bugs</h2>
        <p><a href="http://dinaburg.org/bitsquatting.html">http://dinaburg.org/bitsquatting.html</a><br/>
        <br/>Rowhammer, ECCploit, RAMBleed...</p>
        <p style="margin-top: 2em;"><b>Always checksum data!</b></p>
        <p>&mdash; when writing to file system;</p>
        <p>&mdash; when transmitting over network.</p>
    </section>

    <section class="slide">
        <h2>More Bugs...</h2>

        <p>Production Metrica cluster. An exception comes in response to the query:</p>

        <p style="line-height: 1.5"><b style="color: red;">Checksum doesn't match: corrupted data.</b><br/>Reference: a87ee784054ad3265e316ade23acb8d8.<br/>Actual: 0417637c7f711925046ab4f9d1cf1b68.<br/>Size of compressed block: 773:<br/>while receiving packet from mtxxxlog01-54-3.metrika.yandex.net:9000, 2a02:6b8:...</p>

        <p>Looks familiar! Memory corruption again?</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Checksum doesn't match: corrupted data</h2>

        <p><br/>The error started manifesting on February 6, 2019.</p>
        <p>Reproduces several times a day<br/>among 1000+ servers with ClickHouse.</p>
        <p>We weren't rolling out releases at that time :(</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Checksum doesn't match: corrupted data</h2>

        <p><br/>The error started manifesting on February 6, 2019.</p>
        <p>Reproduces several times a day<br/>among 1000+ servers with ClickHouse.</p>
        <p>We weren't rolling out releases at that time :(</p>

        <p>Couldn't debug the problem<br/>and after a few days, the error disappeared on its own.</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Checksum doesn't match: corrupted data</h2>

        <p><br/>We forgot about it, but on May 15, 2019, the error started manifesting again.</p>
        <p>Reproduces several times a day<br/>among 1000+ servers with ClickHouse.</p>
        <p>Attempts to reproduce, reviewing logs and graphs &mdash; nothing helps.</p>

        <p>If the problem can't be reproduced, the only option<br/>&mdash; collect all cases and <b>look for patterns</b>.</p>
    </section>

    <section class="slide">
        <h2>Looking for Patterns</h2>
<p style="margin-top: -1em;">7 out of 9 servers with E5-2683 v4 were affected by the error, but only about half of the affected are E5-2683 v4.</p>
<p>Doesn't depend on Linux kernel.</p>
<p>Errors usually don't repeat. Except for cluster mtauxyz, where Corrupted data is real (on disk) &mdash; different case.</p>
<p>kern.log &mdash; nothing interesting.</p>
<p>CPU, IO, Network graphs &mdash; nothing interesting.</p>
<p>By network adapter types nothing interesting.</p>
    </section>

    <section class="slide">
        <h2>Looking for Patterns Again</h2>
<p style="margin-top: -1em;">Server uptime is high, they don't crash. No segfaults or similar.</p>
<p>Errors are grouped by days (manifest within a couple of days), but not grouped more locally by time. Solar activity?</p>
<p>For different error cases, the packets themselves match: checksum received, expected, size: most errors have only two packet variants.</p>
<p>Compressed block size is small (less than a kilobyte).</p>
<p>No patterns by servers from which we read data.</p>
<p>Binary representation of packet sizes and checksums is unremarkable.</p>
    </section>

    <section class="slide">
        <h2>Looking for Patterns Yet Again</h2>
<p style="margin-top: -1em;">Only one of the clusters.</p>
<p>Only third replicas, located in Vladimir data center.</p>
<p>These facts coincide with the previous case, which was back in February &mdash; definitely on a different ClickHouse version.</p>
<p>All errors when reading packets over network: while receiving packet from.</p>
<p>The packet on which the error occurred depends on the query structure. For queries differing in structure, error on different checksums. But in queries where the error is on the same checksum, constants differ.</p>
    </section>

    <section class="slide">
        <h2>Not Giving Up, Looking for Patterns</h2>
<p style="margin-top: -1em;">In all queries except one there is GLOBAL JOIN.<br/>But one query is unusually simple:<br/><pre style="font-size: 16pt; margin-top: 0; margin-bottom: 0;">SELECT max(ReceiveTimestamp) FROM tracking_events_all
WHERE APIKey = 1111 AND (OperatingSystem IN ('android', 'ios'))</pre>And compressed block size &mdash; only 75 bytes.</p>
<p>Affected servers are grouped by names:<br/><b>mtxxxlog01-{39..44,57..58,64,68..71,73..74,76}-3</b></p>
<p>Groups of problematic servers match those<br/> from February.</p>
<p>Problematic servers are in VLA-03, VLA-04,<br/> and non-problematic ones &mdash; in VLA-02.</p>
    </section>

    <section class="slide">
        <h2>Debugging by Poking Around</h2>

        <p style="margin-top: -1em;">Let's find in <b>query_log</b> a query with such an error, for which<br/>size of compressed block is small (= 107) and query is simple:</p>
<code style="display: block; white-space: pre; margin: 0 -50px 0 -50px; line-height: 1.5; font-size: 14pt; overflow: hidden;">SELECT hostName() AS h, exception, query
FROM cluster('mtxxxlogs_all_replicas', system.query_log)
WHERE type = 4 AND exception LIKE '%corrupted%' AND event_date >= '2019-01-01'
SETTINGS skip_unavailable_shards = 1

Row 1:
──────
h:         mtxxxlog04-01-3
exception: Code: 40, e.displayText() = DB::Exception: Checksum doesn't match: corrupted data. Reference: f633b841a7a7a80838dd6a89d391bfda. Actual: 8b40502d2ffe5b712b52e03c505ca49f. Size of compressed block: 107.: while receiving packet from mtxxxlog01-14-1.yandex.ru:9000, 2a02:6b8:b011:3000:48fb:2439:729e:4709, e.what() = DB::Exception
query:     SELECT uniqIf(DeviceIDHash,SessionType = 0) AS `ym:ge:users` FROM mobile.generic_events_all WHERE StartDate = toDate('2019-01-01') and APIKey IN (2162208,2174014,2188009,2216512,2216749,2233579,2251144,2254336,2265019,2371901) and EventType = 1 WITH TOTALS  ORDER BY `ym:ge:users` DESC limit 0,100 FORMAT JSONCompact
</code>
    </section>

    <section class="slide">
        <h2>Debugging by Poking Around</h2>

        <p style="margin-top: -1em;">Executed the query using clickhouse-local program to definitely get the same blocks over the network as in that case:</p>

<code style="display: block; white-space: pre; margin: 0 -50px 0 -50px; line-height: 1.5; font-size: 14pt; overflow: hidden;">strace -f -e trace=network -s 1000 -x \
<b>clickhouse-local</b> --query "
    SELECT uniqIf(DeviceIDHash, SessionType = 0)
    FROM remote('127.0.0.{2,3}', mobile.generic_events)
    WHERE StartDate = '2019-02-07' AND APIKey IN (616988,711663,507671,835591,262098,159700,635121,509222)
        AND EventType = 1 WITH TOTALS" --config config.xml</code>

<p style="margin-top: 1em;">The query executes without errors.</p>
<p>Using <b>strace</b> I get a dump of blocks.<br/>
Deciphered the packets and found the expected checksum there.</p>
    </section>

    <section class="slide">
<code style="display: block; white-space: pre; margin: 0 -50px 0 -50px; font-size: 12pt; overflow: hidden;">107 bytes
Reference: <b style="color: green">f633b841a7a7a80838dd6a89d391bfda</b>. Actual: <b style="color: red">8b40502d2ffe5b712b52e03c505ca49f</b>.

\x01\x00
\x08\xa8\xa7\xa7\x41\xb8\x33\xf6\xda\xbf\x91\xd3\x89\x6a\xdd\x38

\x82\x6b\x00\x00\x00\x62\x00\x00\x00\xf2\x3b\x01\x00\x02\xff\xff\xff\xff\x00\x01\x01\x2c\x75\x6e\x69\x71\x49\x66\x28\x44\x65\x76\x69\x63\x65\x49\x44\x48\x61\x73\x68\x2c\x20\x65\x71\x75\x61\x6c\x73\x28\x53\x65\x73\x73\x69\x6f\x6e\x54\x79\x70\x65\x2c\x20\x30\x29\x29\x28\x41\x67\x67\x72\x65\x67\x61\x74\x65\x46\x75\x6e\x63\x74\x69\x6f\x6e\x28\x3f\x00\xf0\x03\x2c\x20\x55\x49\x6e\x74\x36\x34\x2c\x20\x55\x49\x6e\x74\x38\x29\x00\x00

\x01
\x00
<b style="color: green">\x08\xa8\xa7\xa7\x41\xb8\x33\xf6\xda\xbf\x91\xd3\x89\x6a\xdd\x38</b>
\x82
\x6b\x00\x00\x00
\x62\x00\x00\x00
\xf2\x3b\x01\x00\x02\xff\xff\xff\xff\x00
\x01\x01\x2c\x75\x6e\x69\x71\x49\x66\x28
\x44\x65\x76\x69\x63\x65\x49\x44\x48\x61
\x73\x68\x2c\x20\x65\x71\x75\x61\x6c\x73
\x28\x53\x65\x73\x73\x69\x6f\x6e\x54\x79
\x70\x65\x2c\x20\x30\x29\x29\x28\x41\x67
\x67\x72\x65\x67\x61\x74\x65\x46\x75\x6e
\x63\x74\x69\x6f\x6e\x28\x3f\x00\xf0\x03
\x2c\x20\x55\x49\x6e\x74\x36\x34\x2c\x20
\x55\x49\x6e\x74\x38\x29\x00\x00

^A^@^B&lt;FF>&lt;FF>&lt;FF>&lt;FF>^@^A^A,uniqIf(DeviceIDHash, equals(SessionType, 0))(AggregateFunction(uniqIf, UInt64, UInt8)^@^@

01 - field_num
00 - is_overflows
02 - field_num
ffffffff - bucket_num
00 - end of block info

01 - columns
01 - rows
2c 756e69714966284465766963654944486173682c20657175616c732853657373696f6e547970652c20302929    uniqIf(DeviceIDHash, equals(SessionType, 0))
28 41676772656761746546756e6374696f6e28756e697149662c2055496e7436342c2055496e743829            AggregateFunction(uniqIf, UInt64, UInt8)
00 - skip degree
00 - size</code>
    </section>

    <section class="slide">
        <h2>Debugging by Poking Around</h2>
        <p style="margin-top: -1em;">Wrote a program that does bit flip of a bit at every possible position and calculates checksum.</p>

        <p>Found that if you change the value of one bit, you get exactly the corrupted checksum that was in the error message:</p>

        <code style="display: block; white-space: pre; margin: 0 -50px 0 -50px; font-size: 12pt; overflow: hidden; line-height: 1.5;">echo -ne "\x82\x6b\x00\x00\x00\x62\x00\x00\x00\xf2\x3b\x01\x00\x02\xff\xff\xff\xff\x00\x01
\x01\x2c\x75\x6e\x69\x71\x49\x66\x28\x44\x65\x76\x69\x63\x65\x49\x44\x48\x61\x73\x68\x2c\x20
\x65\x71\x75\x61\x6c\x73\x28\x53\x65\x73\x73\x69\x6f\x6e\x54\x79\x70\x65\x2c\x20\x30\x29\x29
\x28\x41\x67\x67\x72\x65\x67\x61\x74\x65\x46\x75\x6e\x63\x74\x69\x6f\x6e\x28\x3f\x00\xf0\x03
\x2c\x20\x55\x49\x6e\x74\x36\x34\x2c\x20\x55\x49\x6e\x74\x38\x29\x00\x00" \
    | ./checksum | grep 8b40502d2ffe5b712b52e03c505ca49f

<b style="color: red">8b40502d2ffe5b712b52e03c505ca49f</b>        32, 6</code>
    </section>

    <section class="slide">
        <h2>Conclusion: Hardware Problem</h2>
        <p>With a software error (for example, memory corruption),<br/><b>single bit flip</b> is unlikely.</p>
        <p>But how to localize the source of the problem?</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">How to Localize Hardware Problem?</h2>
        <p>The problem appeared and disappeared on certain dates.</p>
        <p>Affected servers are grouped by names:<br/>mtxxxlog01-{39..44,57..58,64,68..71,73..74,76}-3</p>
        <p>Groups of problematic servers match those<br/>from February.</p>
        <p>Problematic servers are in VLA-03, VLA-04,<br/>and non-problematic third replicas &mdash; in VLA-02.</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Data Gets Corrupted on Network Switches</h2>
        <p>NOCs reported that they changed switches exactly on those dates.</p>
        <p>After replacing switches, the problem disappeared.</p>
        <p>But:</p>
        <p>&mdash; why doesn't ECC memory on switches help?</p>
        <p>&mdash; why don't TCP checksums help?</p>
        <p>&mdash; why don't Ethernet checksums help?</p>
        <p><a href="https://www.evanjones.ca/tcp-and-ethernet-checksums-fail.html">https://www.evanjones.ca/tcp-and-ethernet-checksums-fail.html</a></p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">But ClickHouse Checksums Help!</h2>
        <p>A 128-bit checksum is calculated for data blocks.</p>
        <p>We correctly report the error to the user.</p>
        <p>Data corrupted during network transmission is not written anywhere.</p>
        <p style="color: green;"><br/>Data stored in ClickHouse remains intact!</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">But ClickHouse Checksums Help.</h2>
        <p>Actually, we calculate three checksums.</p>
        <p>1. For compressed data blocks when writing to file, to network.</p>
        <p>2. Overall checksum of compressed data for verification during replication.</p>
        <p>3. Overall checksum of uncompressed data for verification during replication.</p>
        <p style="color: green; margin-top: 2em;">These checksums don't slow things down!</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Improved Error Message</h2>
        <p style="margin-top: -1em;">
    Code: 40, e.displayText() = DB::Exception: Checksum doesn't match: corrupted data. Reference: c61530c3faa0827150b1634f0f87f274. Actual: d1e57e9605d7100d31df4f1ced3d53d5. Size of compressed block: 405633. The mismatch is caused by <b style="color: green;">single bit flip</b> in data block at byte 332325, bit 6. This is most likely due to hardware failure. If you receive broken data over network and the error does not repeat every time, this can be caused by bad RAM on network interface controller or bad controller itself or bad RAM on network switches or bad CPU on network switches (look at the logs on related network switches; note that TCP checksums don't help) or bad RAM on host (look at dmesg or kern.log for enormous amount of EDAC errors, ECC-related reports, Machine Check Exceptions, mcelog; note that ECC memory can fail if the number of errors is huge) or bad CPU on host. If you read data from disk, this can be caused by disk bit rott. <b style="color: green;">This exception protects ClickHouse from data corruption due to hardware failures</b>.
        </p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Garbage in Data</h2>
        <p>JSON is written to the database in one of the columns</p><p>&mdash; user parameters from JS counter code.</p>
    </section>

    <section class="slide">
<code style="display: block; white-space: pre; margin: 0 -50px 0 -50px; font-size: 12pt; line-height: 1; overflow: hidden;">{"jserrs":{"1392":{"Failed to execute 'postMessage' on 'Window': Invalid target origin
'*­xmlOÀîåhttp[ÂeSans)`USBÆCrugEêXR÷!add[O²done_ÁÅÐnex-µ4noneOQàepreví&lt;put|;4aí abbr¹êalt^&lt;pa
rea¯\rasîÚaxis³kmb2ÈBbaseÔúábdi7*bdo \n#bigRä2JbodyïUbr\r¡»chaA8cit¡Ñ°codevÄcolw▒KcolsQ▒spPdata¿xû
ddS+&del¹ÝNdfn ó*Ndir÷divNdlæÅ|dt5)emZC▒end[¡½faceFfont@?for \rform ;U&lt;h1▒h23\n¤êh4{h5«úh6Ò®hea
dìE³highomhrHvXhref▒¸°lhtml²üjöi\rÆ]id´ì­img\nWinsÅNîisrkbd)kkind~8lang:SW©lib»øjlink&ælistjkÂloopP
lowGÎmainØümap 5åûmarN¡4max@æÌmenuK¥Ömet6!min4äname óþènav³gnobrÌÎeolEÏÑopenSÕpØ partIping&õpre]aÀ
q¯yHrbVÄrelÝjºrevÆoõroleÓrows´Drp,rtObBrtc5Ãrubyz§«sú17sampÂsizmslotÃ|lªspan¿¯srcÂoQstepÒÓðsub*bsu
pÔMtd}*text8!¾;th/time)²ªýtr¤ïtto{=type6▒4Ëu\"¼ul\rvar5~wbrëþswrapH¼xmp­ø4bboxÒRùbiasn{)byåclip¡Lcx
cyõá\"dyò7defsYdescÐdurºxEdxéúsdy|tãfillø5fr6öfromgÓéfx¯îfyÍúgZ ±in▒F×in2 ¶±#kS4ek1Ýák2MQk3îk4O él
ine´maskã=ËmodÜØpath ×ÜrÖçrectaà¶refX4×refYONrxe#âryñ´åseedÇ@osetÞ÷stop Zzsvg¥Ìtoz°u1)P2u2®ãuseªÛv
iewÑDìxîæx1UÇÙx2\rLyÃ®y1'2´zj³0showÚ|mathøûûmiâ 7mnñõmoØUPms)rNodeã7;blurÔúcopy ìgcut0ddrag¬Ìdrop¹
èexit@É=}loadÎêmuteN`£playHpushqßsyncbÑ\\zoomH Ô¾css¬¾iconRp--P!0DateÝÒETagjj½GETr8HEAD!ïLink?_ÌPO
STÑiPUT▒4WøVary 5©tel \"¡url Â¨dateH3ØfilegYÛweekBCridèÙ%scanN all#mËtty átvÀîå\nhttpÀîå\nhttpÀîå\
nhttp\nfileyP\ndataÉä\nwssyP\ndataÀîå\nhttpyP\ndataÏo«B¼PèC B C S\nmidiÀQ\nvr È\nusbB¾ð\n/>% .not1
àBcue 4`left\n ¯ÅI.autoXfq«B«°b\nNnòxtB¸Ð*jpgBBÐJ3140B ÐîG¾.elemB¿°\"ýÿÀ1B²ÐJ100BæH¾.IèØÀMHTMLàNÀ1
®ù£1ttpB °§¶.5562NÀaOKTBµð C B`~BB°p*3371À.0ate▒,èýgzipB¦*jpgB\n¹TyesBðE£±N95teB­ÊjpgÞBð°òb0B°\"Óòd
3BªMNYa00BPØEdaypB§Ð\"¶òb6B£p0:5RÀ9qN\n-B¾°¡ëÇchatB¬\"²òb2B¾0\n4561B·0Êc3B@*jpgBB¦0 2¾îwideB¤·xroo
tB¢õ.pt22B» Npt17B® }}Rpt21BÐ}@ï\nenr1B`r¤¢pt20B¼ð*jpgÞB´`?OÔpt19BÐ¨ þ.4777B¢ ç [pt18B0*jpgBBÐW$AB
~¡=pt16Bª°\"Õòd5B§ `8·pt15B·ÌN6157B® ¾vSpt14Tahoma1Bº`1bËpt13BÊjpgÞB¶À°jpt12B§P ▒r.5768Bàþâ>pt11B·
?BИCBWB(DBBP^B? Bш?B@?BяяяяяяяяяяяяяяяяяяяяяяяяLяяяяяяяяяяяяяяяяяяяяяяяяЬаAР1яяяяяяяя0ПT?ПTПThПTРП
T8йОTр\nПT \nПTpкОTиОTЁЮОTа?ОTx?ОT@?ОT?ЙОTdGИ1¤GИ1яяяяяяяяяяяяяяяяяяяяяяяяL@sР1яяяяр?B`ОВ1ёB`ОВ1?B
8BАBР?BPYюEяяяя2тґ?\rhttp://avatar.botva.ru/fight_log.php?log_id=123456x\\х1!`ОВ1яяяяяяяяяяяяяяяяя
яяяяяяяяИCB?жB(DBBюяяя JBюяяяюяяяюяяяюяяяюяяяюяяя▒BGB> B0:>5 MDD5:B ?@O6:8?ИCBШєB(DBBИ¤mB8ЧmBИ№mB6n
B -nBЁДmBр?BB?tHB ?B3?ж\rhttps://i.botva.ru/css/colorbox/images/controls.pngяяяяяяяяpBР?BX)BИ§mBа:
nBp`mBяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяяя`?BШ?B0ґBя}B`сm-?Жd\rhttps://i.botva.ru/i/global/icon
/promo200.pngose(µЙT??ЙT??ЙTP«ЙTяяяяяяяяяяяяяяяяяяяяЬяяяяяяяяюяяя?JBюяяяюяяяюяяяюяяяюяяяюяяя-\nhtt
ps://www.google-analytics.com/analytics.js4d\\&lt;\rhttps://i.botva.ru/i/global ýclass+Plassij3cod
ebas(.rcodetyp×ø8colgroupQ»)colorw>colspan- command×¢compactZ­4icontent³h8controlsmt27BºPé'MNap11BW
:mt26Bp\nwoffB«@u-úmt25B¨°*+6Ù1BÀ¾t/mt24 OÔ1À9qJ\nBB­@\\Rmt23B¤¼òbcB¯ÑÔLmt22B¨\njpgBB Cc³mt21B¼°h¨N
399BB´\"çmt20B¥°105B­à^³mt19B«ÐBðCàBB¬àv°mt18q2.12Ó1B¶ ºmt17B© v½B0Â1pTHBB`!Émt16B¯0½òbdB@Ü/omt15B¹
°i÷ÊÎ3483B¾`æhÉmt14B¹PJ100BB0Ûÿmt13BPù.\n                        B»ML±mt12B¥!7îJbtnCB@%©»mt11­Ú§.15
ÿÿB¦óAtmt10Bp.¤bc2vB¨ ÀîÝmt92BðC B¸õCB£LJmt83B¨Ð(L5780B¶)ùmt74B\"Áòc1B Fìmt65B¤PÀÀ1Ð£À1 À1B \"Îmt5
6BÃ|IExB`4        çmt47B0mµ.2093Bñ3[mt38B²P\n...B«ÀøD)mt29B *jpglB­9\\mt1aB¬¸òb8B¾
</code>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Garbage in Data</h2>
        <img style="float: right; width: 230px;" src="pictures/frustration.jpg"/>
        <p>Memory corruption again?</p>
        <p>Race condition?</p>
        <p>And how are we going to debug this?</p>
        <p>And why did we choose C++ language?</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Garbage in Data</h2>
        <p>Path to the solution:</p>
        <p>&mdash; it's garbage, but valid UTF-8;</p>
        <p>&mdash; the same garbage was written to two clusters independently;</p>
        <p>&mdash; there are lots of &laquo;<b style="color: red;">я</b>&raquo; letters in the garbage!</p>
    </section>

    <section class="slide">
        <h2 style="font-size: 32pt;">Bugs from All Over the Internet</h2>
        <p>Yandex.Metrica collects traffic from > 1 billion devices on the internet.</p>
        <p>The database stores > 30,000,000,000,000 rows (page views).</p>
        <p>User devices sometimes have bugs...</p>
        <p style="color: green;">These bugs are better filtered before writing to database.</p>
    </section>

    <section class="slide">
        <h2>Thank You!</h2>
    </section>


    <div class="progress"></div>
    <script src="shower/shower.min.js"></script>

    <!--Video plugin-->
    <link rel="stylesheet" href="shower/shower-video.css">
    <script src="shower/shower-video.js"></script>
    <!--/Video plugin-->
</body>
</html>
