<!DOCTYPE html>
<html lang="en">
<head>
    <title>Even Newer ClickHouse Features</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:image" content="pictures/preview.png">
    <meta property="og:title" content="Even Newer ClickHouse Features">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="pictures/preview.png">
    <link rel="stylesheet" href="shower/themes/yandex/styles/screen-16x10.css">
    
    <style type="text/css">
         code { display: block; white-space: pre; background-color: #EEE; }
    </style>
</head>
<body class="shower list">
    <header class="caption">
        <h1>Even Newer ClickHouse Features</h1>
    </header>
    
    <section class="slide">
        <h1 style="font-size: 34pt;">ClickHouse Online Meetup</h1>
        <p style="margin-top: 1em;">YouTube stream: <a href="https://www.youtube.com/c/ClickHouseDB">https://www.youtube.com/c/ClickHouseDB</a></p>
        <p>Telegram chat: <a href="https://telegram.me/clickhouse_ru">https://telegram.me/clickhouse_ru</a>, <a href="https://telegram.me/clickhouse_en">clickhouse_en</a></p>
        
        <p style="margin-top: 3em;"><b>T-shirts for questions!</b><br/><br/>If you asked a question via Zoom<br/>&mdash; write to me in Telegram after the event:<br/>
        your question, t-shirt size and courier delivery address.</p>
    </section>

    <section class="slide" id="cover">
        <h1 style="margin-top: 180px; font-size: 48pt;"><span>Even Newer ClickHouse Features</h1>
    </section>

<section class="slide">
<h2 style="font-size: 30pt;">New Data Format in MergeTree</h2>
<p>&mdash; Compact data parts (since version <span style="color: green">20.3</span>).</p>
<p>&mdash; Data parts in memory (since version <span style="color: green">20.6</span>).</p>
<p>&mdash; Write-Ahead Log (since version <span style="color: green">20.6</span>).</p>
<p>&mdash; Durability settings (since version <span style="color: gray">20.10</span>).</p>

<p style="margin-top: 100px; font-size: 14pt; color: gray;">Разработчик &mdash; Антон Попов.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Three Data Part Formats</h2>
<p>1. Wide &mdash; классический format.</p>
<p>2. Compact &mdash; все столбцы в одном файле.</p>
<p>3. Memory &mdash; данные в оперативке.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Three Data Part Formats</h2>
<p>Controlled by settings:</p>
<p>&mdash; <b>min_bytes_for_wide_part</b>,<br/>&emsp; <b>min_rows_for_wide_part</b>:</p>
<p>&emsp; если размер больше &mdash; использовать <b>wide</b> format.</p>
<p>&mdash; <b>min_bytes_for_compact_part</b>,<br/>&emsp; <b>min_rows_for_compact_part</b>:</p>
<p>&emsp; если размер больше &mdash; использовать <b>compact</b> формат,<br/>
&emsp; если меньше &mdash; использовать memory format.</p>
<p>Wide > Compact > Memory</p>
</section>


<section class="slide">
<h2 style="font-size: 30pt;">Wide Parts</h2>
<p>Классический format.</p>
<p>Each column and index in a separate file.</p>
<p>Optimal for reading data from disks, including slow ones.</p>
<p>Cheap ALTER for adding or removing columns.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Compact Parts</h2>
<p>All columns in one file.</p>
<p style="color: green;">Optimal for inserting new data.<br/>
Especially on slow filesystems.</p>
<p style="color: red;">Less optimal for reading.</p>

<p>Recommended for small-sized data parts.</p>
<p>Not recommended to use for all parts.</p>

<p>Available since version 20.3, but disabled by default.<br/>
Since version 20.10 will be used for parts up to 10 MB.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">In-Memory Parts</h2>
<img style="float: left; height: 60%; margin-left: -60px; margin-top: -60px; margin-right: 20px;" src="pictures/optimal.webp" />
<p>Data in RAM.</p>
<p>+ Write-Ahead Log, can be disabled.</p>

<p>&mdash; in_memory_parts_enable_wal;<br/>
&mdash; write_ahead_log_max_bytes.</p>

<p><span style="color: green;">Even more optimal for inserting new data...</span><br/>
... if write-ahead log is disabled.</p>

<p><span style="color: green;">More efficient for reading...</span><br/>
... but data in RAM is uncompressed.</p>

<p>All parts are replicated as usual.</p>

<p style="color: gray">Experimental feature.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Durability</h2>
<p>If all your data is on one server...</p>
<p>If you don't use replication...</p>
<p>If replication exists, but within one region...</p>

<p style="margin-top: 2em; color: green;">&mdash; should we just call fsync before INSERT response?</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Durability</h2>
<p>Eat My Data (2007):<br/>
<a href="https://www.youtube.com/watch?v=LMe7hf2G1po">https://www.youtube.com/watch?v=LMe7hf2G1po</a></p>

<p>Files Are Hard (2015):<br/>
<a href="https://danluu.com/file-consistency/">https://danluu.com/file-consistency/</a></p>

<p>PostgreSQL "Fsyncgate" (2018):<br/>
<a href="https://lwn.net/Articles/752063/">https://lwn.net/Articles/752063/</a></p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Durability</h2>
<p>If all your data is on one server...<br/>
If you don't use replication...<br/>
If replication exists, but within one region...</p>

<p style="color: green;">Then here:</p>

<p>&mdash; min_rows_to_fsync_after_merge;
<br/>&mdash; min_compressed_bytes_to_fsync_after_merge;
<br/>&mdash; min_compressed_bytes_to_fsync_after_fetch;
<br/>&mdash; fsync_after_insert;
<br/>&mdash; fsync_part_directory;
<br/>&mdash; write_ahead_log_bytes_to_fsync;
<br/>&mdash; write_ahead_log_interval_ms_to_fsync;
<br/>&mdash; in_memory_parts_insert_sync.</p>
</section>


<section class="slide">
<h2 style="font-size: 30pt;">Query Normalization and Obfuscation</h2>
<p>Functions <b>normalizeQuery</b>, <b>normalizedQueryHash</b>.</p>
<code>SELECT <b>normalizeQuery</b>(query) FROM system.query_log</code>
<p style="margin-top: 2em;">&mdash; replace literals with <span style="background-color: #EEE; padding: 5px 10px; font-family: Monospace;">?</span></p>
<p>&mdash; replace lists of literals with <span style="background-color: #EEE; padding: 5px 10px; font-family: Monospace;">?..</span></p>
<p>&mdash; replace complex aliases with <span style="background-color: #EEE; padding: 5px 10px; font-family: Monospace;">`?`</span></p>

<p style="margin-top: 100px; font-size: 14pt; color: green;">Available since version 20.8.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Query Obfuscation</h2>
<p>A friend of mine had a slow query...<br/>
... but he didn't want to show it.</p>
<p>Solution:</p>
<code>clickhouse-format --<b>obfuscate</b> &lt; query.sql</code>

<p style="margin-top: 100px; font-size: 14pt; color: gray;">Available since version 20.10.</p>
<p style="font-size: 14pt; color: gray;">Data obfuscation: <a href="https://www.youtube.com/watch?v=2iR7i4akL44">https://www.youtube.com/watch?v=2iR7i4akL44</a></p>
</section>

<section class="slide" style="background-image: url('pictures/query.png'); background-size: 100%;">
&nbsp;
</section>


<section class="slide">
<h2 style="font-size: 30pt;">Recompression of Old Data</h2>
<code>CREATE TABLE hits
(
  event_time DateTime,
  ...
) ENGINE MergeTree ORDER BY ...

<b>TTL</b> event_time + INTERVAL 1 MONTH
        <b>RECOMPRESS</b> CODEC(ZSTD(1)), 
    event_time + INTERVAL 1 YEAR
        <b>RECOMPRESS</b> CODEC(ZSTD(6))</code>

<p style="margin-top: 100px; font-size: 14pt; color: gray;">Разработчик &mdash; Александр Сапин. Available since version 20.10.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">ALTER Improvements</h2>
<code>CREATE TABLE hits
(
  event_time DateTime CODEC(Delta, <b>Default</b>),
  ...
) ENGINE MergeTree ORDER BY ...</code>

<code style="margin-top: 2em;">ALTER TABLE hits MODIFY COLUMN c
    <b>REMOVE</b> COMMENT|CODEC|TTL
        |DEFAULT|MATERIALIZED|ALIAS</code>

<p style="margin-top: 100px; font-size: 14pt; color: gray;">Разработчик &mdash; Александр Сапин. Available since version 20.10.</p>
</section>

<section class="slide">
<h2 style="font-size: 30pt;">Column List Transformations</h2>
<code>SELECT * <b>EXCEPT</b>(secret_column) FROM table;</code>
<code style="margin-top: 0.5em;">SELECT table.* <b>REPLACE</b>(
  (URL LIKE '%yandex%' ? '' : URL) AS URL) FROM table;</code>
<code style="margin-top: 0.5em;">SELECT <b>COLUMNS('^packet_')</b> FROM table;</code>
<code style="margin-top: 0.5em;">SELECT t.* <b>APPLY</b>(sum) FROM table AS t;</code>
<code style="margin-top: 0.5em;">SELECT <b>COLUMNS(x, y, z)</b> <b>APPLY</b>(sum) FROM table;</code>

<p style="margin-top: 100px; font-size: 14pt; color: gray;">Разработчик &mdash; Amos Bird, mfridental. Available since version 20.10.</p>
<p style="font-size: 14pt; color: gray;">COLUMNS('regexp'): разработчик &mdash; mfridental. Доступно с версии <span style="color: green;">19.12</span>.</p>
</section>


<section class="slide">
<h2 style="font-size: 30pt;">New ClickHouse Versions</h2>
<p style="color: gray">20.10 &mdash; testing.</p>
<p style="color: green">20.9 &mdash; stable.</p>
<p style="color: green">20.8 &mdash; LTS until 2021-09-30.</p>
<p style="color: green">20.7 &mdash; stable.</p>
<p style="color: gray">20.6 ... 20.4 &mdash; obsolete.</p>
<p style="color: green">20.3 &mdash; LTS until 2021-03-12.</p>
<p>...</p>
<p style="color: gray">19.14 &mdash; obsolete.</p>
</section>


<section class="slide">
<h2 style="font-size: 30pt;">What Else?</h2>
<p>Data import from RabbitMQ.</p>
<p>Kerberos authentication for Kafka.</p>
<p>Beta unlimited storage in Yandex.Cloud.</p>
<p>WITH for subqueries and with global scope.</p>
<p>Formats Regexp, RawBLOB, JSONAsString, LinesAsString.</p>
<p>Running clickhouse without packages and configuration.</p>
<p>system.crash_log table, Sentry.</p>
<p>Rank correlation calculation.</p>
<p>256bit Decimal.</p>
</section>


<section class="slide">
<h2 style="font-size: 30pt;">What's Next?</h2>
<p>Backups.</p>
<p>Projections.</p>
<p>Move away from ZooKeeper.</p>
<p>OpenTracing support.</p>
<p>Query hedging.</p>
<p>Reading column slices.</p>
<p>Functions анализа геоданных.</p>
<p>Text near-duplicate analysis.</p>
</section>


<section class="slide">
    <h2>Public roadmap 2020.</h2>
    <p><a href="https://clickhouse.tech/docs/ru/whats-new/extended-roadmap/">https://clickhouse.tech/docs/ru/whats-new/extended-roadmap/</a></p>
    <p>~ 500 задач с подробным описанием &mdash; зависимости, исполнители...</p>
</section>


<section class="slide">
    <h2>.</h2>
</section>

    <div class="progress"></div>
    <script src="shower/shower.min.js"></script>
</body>
</html>
